name: Simple Release

on:
  push:
    tags:
      - "v*.*.*"
  workflow_dispatch:
    inputs:
      version:
        description: "ç‰ˆæœ¬å· (ä¾‹å¦‚: v1.0.0)"
        required: true
        default: "v1.0.0"

permissions:
  contents: write
  packages: write

jobs:
  # åˆ›å»º GitHub Release
  create-release:
    name: åˆ›å»º GitHub Release
    runs-on: ubuntu-latest
    outputs:
      upload_url: ${{ steps.release.outputs.upload_url }}
      version: ${{ steps.tag.outputs.version }}

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: è·å–ç‰ˆæœ¬å·
        id: tag
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "version=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
          else
            echo "version=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
          fi

      - name: ç”Ÿæˆå˜æ›´æ—¥å¿—
        id: changelog
        run: |
          # è·å–å½“å‰æ ‡ç­¾ä¸å‰ä¸€ä¸ªæ ‡ç­¾ä¹‹é—´çš„æäº¤
          PREVIOUS_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")

          if [ -n "$PREVIOUS_TAG" ]; then
            echo "## ğŸ“¦ ç‰ˆæœ¬ ${{ steps.tag.outputs.version }}" > CHANGELOG.md
            echo "" >> CHANGELOG.md
            echo "### ğŸ”„ å˜æ›´å†…å®¹" >> CHANGELOG.md
            git log --pretty=format:"- %s (%h)" $PREVIOUS_TAG..HEAD >> CHANGELOG.md
            echo "" >> CHANGELOG.md
          else
            echo "## ğŸ“¦ ç‰ˆæœ¬ ${{ steps.tag.outputs.version }}" > CHANGELOG.md
            echo "" >> CHANGELOG.md
            echo "### ğŸ‰ é¦–æ¬¡å‘å¸ƒ" >> CHANGELOG.md
            echo "è¿™æ˜¯é¡¹ç›®çš„é¦–æ¬¡å‘å¸ƒç‰ˆæœ¬ã€‚" >> CHANGELOG.md
            echo "" >> CHANGELOG.md
          fi

          echo "### ğŸ”— ç›¸å…³é“¾æ¥" >> CHANGELOG.md
          echo "- [æŸ¥çœ‹å®Œæ•´å˜æ›´è®°å½•](https://github.com/${{ github.repository }}/commits/${{ github.sha }})" >> CHANGELOG.md

          # è®¾ç½®è¾“å‡º
          echo "changelog<<EOF" >> $GITHUB_OUTPUT
          cat CHANGELOG.md >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: åˆ›å»º Release
        id: release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ steps.tag.outputs.version }}
          release_name: Release ${{ steps.tag.outputs.version }}
          body: ${{ steps.changelog.outputs.changelog }}
          draft: false
          prerelease: false

  # æ„å»ºå¹¶å‘å¸ƒ Docker é•œåƒ
  publish-docker:
    name: å‘å¸ƒ Docker é•œåƒ
    runs-on: ubuntu-latest
    needs: create-release
    permissions:
      contents: read
      packages: write

    strategy:
      matrix:
        component: [backend, frontend]

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: è®¾ç½® Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: ç™»å½•åˆ° GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: æå–å…ƒæ•°æ®
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ghcr.io/${{ github.repository }}-${{ matrix.component }}
          tags: |
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=semver,pattern={{major}}
            type=raw,value=latest

      - name: æ„å»ºå¹¶æ¨é€é•œåƒ
        uses: docker/build-push-action@v5
        with:
          context: ./${{ matrix.component }}
          file: ./${{ matrix.component }}/Dockerfile
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          build-args: |
            VERSION=${{ needs.create-release.outputs.version }}
            BUILD_DATE=${{ github.event.head_commit.timestamp }}
            COMMIT_SHA=${{ github.sha }}

  # å‘é€é€šçŸ¥
  notify:
    name: å‘é€å‘å¸ƒé€šçŸ¥
    runs-on: ubuntu-latest
    needs: [create-release, publish-docker]
    if: always()

    steps:
      - name: ç”Ÿæˆå‘å¸ƒé€šçŸ¥
        run: |
          echo "## ğŸ‰ ç‰ˆæœ¬å‘å¸ƒå®Œæˆ!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ“‹ å‘å¸ƒä¿¡æ¯" >> $GITHUB_STEP_SUMMARY
          echo "- **ç‰ˆæœ¬å·:** \`${{ needs.create-release.outputs.version }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "- **å‘å¸ƒæ—¶é—´:** $(date -u +'%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### âœ… ä»»åŠ¡çŠ¶æ€" >> $GITHUB_STEP_SUMMARY
          echo "- åˆ›å»º Release: ${{ needs.create-release.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Docker é•œåƒ: ${{ needs.publish-docker.result }}" >> $GITHUB_STEP_SUMMARY

      # æ£€æŸ¥æ˜¯å¦é…ç½®äº†é€šçŸ¥webhook
      - name: Check notification webhooks
        id: webhook-check
        run: |
          if [ -n "${{ secrets.DINGTALK_WEBHOOK }}" ]; then
            echo "dingtalk=true" >> $GITHUB_OUTPUT
          else
            echo "dingtalk=false" >> $GITHUB_OUTPUT
          fi

          if [ -n "${{ secrets.SLACK_WEBHOOK_URL }}" ]; then
            echo "slack=true" >> $GITHUB_OUTPUT
          else
            echo "slack=false" >> $GITHUB_OUTPUT
          fi

      # å‘é€é’‰é’‰é€šçŸ¥
      - name: å‘é€é’‰é’‰é€šçŸ¥
        if: steps.webhook-check.outputs.dingtalk == 'true'
        run: |
          curl -X POST "${{ secrets.DINGTALK_WEBHOOK }}" \
            -H 'Content-Type: application/json' \
            -d '{
              "msgtype": "markdown",
              "markdown": {
                "title": "ğŸ‰ videoAll æ–°ç‰ˆæœ¬å‘å¸ƒ",
                "text": "## ğŸ‰ videoAll ${{ needs.create-release.outputs.version }} å‘å¸ƒæˆåŠŸ!\n\n**å‘å¸ƒæ—¶é—´:** $(date -u +'%Y-%m-%d %H:%M:%S UTC')\n\n**Commit:** ${{ github.sha }}\n\n[æŸ¥çœ‹ Release](https://github.com/${{ github.repository }}/releases/tag/${{ needs.create-release.outputs.version }})"
              }
            }'
        continue-on-error: true

      # å‘é€Slacké€šçŸ¥
      - name: å‘é€ Slack é€šçŸ¥
        if: steps.webhook-check.outputs.slack == 'true'
        uses: 8398a7/action-slack@v3
        with:
          status: ${{ job.status }}
          text: |
            ğŸ‰ videoAll ${{ needs.create-release.outputs.version }} å‘å¸ƒæˆåŠŸ!
            æŸ¥çœ‹è¯¦æƒ…: https://github.com/${{ github.repository }}/releases/tag/${{ needs.create-release.outputs.version }}
          webhook_url: ${{ secrets.SLACK_WEBHOOK_URL }}
        continue-on-error: true

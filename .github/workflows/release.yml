name: ç‰ˆæœ¬å‘å¸ƒ

on:
  push:
    tags:
      - 'v*.*.*'
  workflow_dispatch:
    inputs:
      version:
        description: 'ç‰ˆæœ¬å· (ä¾‹å¦‚: v1.0.0)'
        required: true
        default: 'v1.0.0'
      prerelease:
        description: 'æ˜¯å¦ä¸ºé¢„å‘å¸ƒç‰ˆæœ¬'
        required: false
        default: false
        type: boolean

permissions:
  contents: write
  packages: write

jobs:
  # åˆ›å»º GitHub Release
  create-release:
    name: åˆ›å»º GitHub Release
    runs-on: ubuntu-latest
    outputs:
      upload_url: ${{ steps.release.outputs.upload_url }}
      version: ${{ steps.tag.outputs.version }}

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: è·å–ç‰ˆæœ¬å·
        id: tag
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "version=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
          else
            echo "version=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
          fi

      - name: ç”Ÿæˆå˜æ›´æ—¥å¿—
        id: changelog
        uses: actions/github-script@v7
        with:
          script: |
            const { version } = require('./package.json');
            const fs = require('fs');

            // è·å–å½“å‰æ ‡ç­¾ä¸å‰ä¸€ä¸ªæ ‡ç­¾ä¹‹é—´çš„æäº¤
            const { data: commits } = await github.rest.repos.listCommits({
              owner: context.repo.owner,
              repo: context.repo.repo,
              per_page: 100
            });

            // æŒ‰æäº¤ç±»å‹åˆ†ç»„
            const features = [];
            const fixes = [];
            const others = [];

            for (const commit of commits) {
              if (!commit.commit.message) continue;

              const msg = commit.commit.message.split('\n')[0];
              if (msg.startsWith('feat(')) {
                features.push(`- ${msg} (${commit.sha.substring(0, 7)})`);
              } else if (msg.startsWith('fix(')) {
                fixes.push(`- ${msg} (${commit.sha.substring(0, 7)})`);
              }
            }

            let changelog = `## ğŸ“¦ ç‰ˆæœ¬ ${context.payload.inputs.version || context.ref.replace('refs/tags/', '')}\n\n`;
            changelog += `### âœ¨ æ–°åŠŸèƒ½\n${features.length ? features.join('\n') : 'æ— '}\n\n`;
            changelog += `### ğŸ› é—®é¢˜ä¿®å¤\n${fixes.length ? fixes.join('\n') : 'æ— '}\n\n`;
            changelog += `### ğŸ“ å…¶ä»–æ›´æ–°\n${others.length ? others.join('\n') : 'æ— '}\n\n`;
            changelog += `### ğŸ”— ç›¸å…³é“¾æ¥\n`;
            changelog += `- [æŸ¥çœ‹å®Œæ•´å˜æ›´è®°å½•](https://github.com/${context.repo.owner}/${context.repo.repo}/commits/${context.sha})\n`;

            return changelog;

      - name: åˆ›å»º Release
        id: release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ steps.tag.outputs.version }}
          release_name: Release ${{ steps.tag.outputs.version }}
          body: ${{ steps.changelog.outputs.result }}
          draft: false
          prerelease: ${{ github.event.inputs.prerelease || false }}

  # æ„å»ºå¹¶å‘å¸ƒ Docker é•œåƒ
  publish-docker:
    name: å‘å¸ƒ Docker é•œåƒ
    runs-on: ubuntu-latest
    needs: create-release
    permissions:
      contents: read
      packages: write

    strategy:
      matrix:
        component: [backend, frontend, app]

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: è®¾ç½® Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: ç™»å½•åˆ° GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: ç™»å½•åˆ° Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: æå–å…ƒæ•°æ®
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: |
            ghcr.io/${{ github.repository }}${{ matrix.component == 'app' && '' || '-' }}${{ matrix.component }}
            docker.io/${{ secrets.DOCKERHUB_USERNAME }}/${{ github.repository }}${{ matrix.component == 'app' && '' || '-' }}${{ matrix.component }}
          tags: |
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=semver,pattern={{major}}
            type=raw,value=latest,enable=${{ matrix.component == 'app' }}

      - name: æ„å»ºå¹¶æ¨é€é•œåƒ
        uses: docker/build-push-action@v5
        with:
          context: ${{ matrix.component == 'app' && '.' || format('./{0}', matrix.component) }}
          file: ${{ matrix.component == 'app' && './Dockerfile' || format('./{0}/Dockerfile', matrix.component) }}
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          build-args: |
            VERSION=${{ needs.create-release.outputs.version }}
            BUILD_DATE=${{ github.event.head_commit.timestamp }}
            COMMIT_SHA=${{ github.sha }}

      - name: è¾“å‡ºé•œåƒä¿¡æ¯
        run: |
          echo "### ğŸ³ Docker é•œåƒå·²å‘å¸ƒ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**${{ matrix.component }}:**" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo ${{ steps.meta.outputs.tags }} | tr ' ' '\n' >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

  # æ„å»ºå¹¶å‘å¸ƒå®‰è£…åŒ…
  build-packages:
    name: æ„å»ºå®‰è£…åŒ…
    runs-on: ubuntu-latest
    needs: create-release

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: è®¾ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: å®‰è£…ä¾èµ–å¹¶æ„å»º
        run: |
          cd frontend && npm ci && npm run build
          cd ../backend && npm ci --production
          cd ..

      - name: åˆ›å»ºå‘å¸ƒåŒ…
        run: |
          # åˆ›å»ºä¸´æ—¶ç›®å½•
          mkdir -p release-package

          # å¤åˆ¶å¿…è¦æ–‡ä»¶
          cp -r frontend/dist release-package/frontend
          cp -r backend release-package/backend
          cp -r media_parser_sdk release-package/
          cp docker-compose.yml release-package/ 2>/dev/null || echo "docker-compose.yml not found"
          cp README.md release-package/ 2>/dev/null || echo "README.md not found"

          # åˆ›å»ºéƒ¨ç½²è„šæœ¬
          cat > release-package/deploy.sh << 'EOF'
          #!/bin/bash
          echo "å¼€å§‹éƒ¨ç½² videoAll..."
          # è¿™é‡Œæ·»åŠ éƒ¨ç½²é€»è¾‘
          EOF
          chmod +x release-package/deploy.sh

          # æ‰“åŒ…
          tar -czf videoall-${{ needs.create-release.outputs.version }}.tar.gz -C release-package .

      - name: ä¸Šä¼ å‘å¸ƒåŒ…åˆ° Release
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ needs.create-release.outputs.upload_url }}
          asset_path: ./videoall-${{ needs.create-release.outputs.version }}.tar.gz
          asset_name: videoall-${{ needs.create-release.outputs.version }}.tar.gz
          asset_content_type: application/gzip

  # å‘é€é€šçŸ¥
  notify:
    name: å‘é€å‘å¸ƒé€šçŸ¥
    runs-on: ubuntu-latest
    needs: [create-release, publish-docker, build-packages]
    if: always()

    steps:
      - name: ç”Ÿæˆå‘å¸ƒé€šçŸ¥
        run: |
          echo "## ğŸ‰ ç‰ˆæœ¬å‘å¸ƒå®Œæˆ!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ“‹ å‘å¸ƒä¿¡æ¯" >> $GITHUB_STEP_SUMMARY
          echo "- **ç‰ˆæœ¬å·:** \`${{ needs.create-release.outputs.version }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "- **å‘å¸ƒæ—¶é—´:** $(date -u +'%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### âœ… ä»»åŠ¡çŠ¶æ€" >> $GITHUB_STEP_SUMMARY
          echo "- åˆ›å»º Release: ${{ needs.create-release.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Docker é•œåƒ: ${{ needs.publish-docker.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- å®‰è£…åŒ…: ${{ needs.build-packages.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸš€ å¿«é€Ÿå¼€å§‹" >> $GITHUB_STEP_SUMMARY
          echo '```bash' >> $GITHUB_STEP_SUMMARY
          echo "docker pull ghcr.io/${{ github.repository }}:${{ needs.create-release.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

      # å¯é€‰ï¼šå‘é€é’‰é’‰/ä¼ä¸šå¾®ä¿¡/Slack é€šçŸ¥
      - name: å‘é€é’‰é’‰é€šçŸ¥ (å¯é€‰)
        if: ${{ secrets.DINGTALK_WEBHOOK != '' }}
        run: |
          curl -X POST "${{ secrets.DINGTALK_WEBHOOK }}" \
            -H 'Content-Type: application/json' \
            -d '{
              "msgtype": "markdown",
              "markdown": {
                "title": "ğŸ‰ videoAll æ–°ç‰ˆæœ¬å‘å¸ƒ",
                "text": "## ğŸ‰ videoAll ${{ needs.create-release.outputs.version }} å‘å¸ƒæˆåŠŸ!\n\n**å‘å¸ƒæ—¶é—´:** $(date -u +'%Y-%m-%d %H:%M:%S UTC')\n\n**Commit:** ${{ github.sha }}\n\n[æŸ¥çœ‹ Release](https://github.com/${{ github.repository }}/releases/tag/${{ needs.create-release.outputs.version }})"
              }
            }'
        continue-on-error: true

      - name: å‘é€ Slack é€šçŸ¥ (å¯é€‰)
        if: ${{ secrets.SLACK_WEBHOOK_URL != '' }}
        uses: 8398a7/action-slack@v3
        with:
          status: ${{ job.status }}
          text: |
            ğŸ‰ videoAll ${{ needs.create-release.outputs.version }} å‘å¸ƒæˆåŠŸ!
            æŸ¥çœ‹è¯¦æƒ…: https://github.com/${{ github.repository }}/releases/tag/${{ needs.create-release.outputs.version }}
          webhook_url: ${{ secrets.SLACK_WEBHOOK_URL }}
        continue-on-error: true

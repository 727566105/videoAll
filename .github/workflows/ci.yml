name: æŒç»­é›†æˆ (CI)

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  # åŽç«¯æµ‹è¯•å’Œä»£ç æ£€æŸ¥
  backend-test:
    name: åŽç«¯æµ‹è¯•ä¸Žæ£€æŸ¥
    runs-on: ubuntu-latest
    env:
      NODE_VERSION: 20

    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: test_user
          POSTGRES_PASSWORD: test_password
          POSTGRES_DB: video_all_test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: è®¾ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: æ¸…é™¤æ—§çš„ npm ç¼“å­˜
        run: |
          echo "æ¸…é™¤å¯èƒ½å­˜åœ¨çš„ Node.js 18 ç¼“å­˜..."
          rm -rf ~/.npm/_cacache/index-v5 || true
          npm cache clean --force

      - name: éªŒè¯ Node.js ç‰ˆæœ¬
        run: |
          echo "Node version: $(node --version)"
          echo "NPM version: $(npm --version)"
          if [ $(node -v | cut -d'.' -f1 | sed 's/v//') -lt 20 ]; then
            echo "âŒ Node.js ç‰ˆæœ¬å¿…é¡» >= 20"
            exit 1
          fi
          echo "âœ… Node.js ç‰ˆæœ¬éªŒè¯é€šè¿‡"

      - name: æ¸…ç†åŽç«¯ node_modules
        working-directory: ./backend
        run: |
          echo "åˆ é™¤æ—§çš„ node_modules..."
          rm -rf node_modules package-lock.json
          echo "âœ… æ¸…ç†å®Œæˆ"

      - name: å®‰è£…åŽç«¯ä¾èµ–
        working-directory: ./backend
        run: |
          echo "ä½¿ç”¨ npm install å®‰è£…ä¾èµ–..."
          npm install --no-audit --no-fund

      - name: ä»£ç æ£€æŸ¥ (ESLint)
        working-directory: ./backend
        run: npm run lint --if-present
        continue-on-error: true

      - name: è¿è¡Œå•å…ƒæµ‹è¯•
        working-directory: ./backend
        env:
          POSTGRES_HOST: localhost
          POSTGRES_PORT: 5432
          POSTGRES_USER: test_user
          POSTGRES_PASSWORD: test_password
          POSTGRES_DATABASE: video_all_test
          NODE_ENV: test
        run: npm test
        continue-on-error: true

      - name: ç”Ÿæˆæµ‹è¯•è¦†ç›–çŽ‡æŠ¥å‘Š
        working-directory: ./backend
        run: npm run test:coverage --if-present
        continue-on-error: true

      - name: ä¸Šä¼ è¦†ç›–çŽ‡æŠ¥å‘Š
        uses: codecov/codecov-action@v3
        if: success()
        with:
          files: ./backend/coverage/lcov.info
          flags: backend
          name: backend-coverage

  # å‰ç«¯æµ‹è¯•å’Œæž„å»º
  frontend-test:
    name: å‰ç«¯æµ‹è¯•ä¸Žæž„å»º
    runs-on: ubuntu-latest
    env:
      NODE_VERSION: 20

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: è®¾ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: æ¸…é™¤æ—§çš„ npm ç¼“å­˜
        run: |
          echo "æ¸…é™¤å¯èƒ½å­˜åœ¨çš„ Node.js 18 ç¼“å­˜..."
          rm -rf ~/.npm/_cacache/index-v5 || true
          npm cache clean --force

      - name: éªŒè¯ Node.js ç‰ˆæœ¬
        run: |
          echo "Node version: $(node --version)"
          echo "NPM version: $(npm --version)"
          echo "Vite è¦æ±‚: Node.js 20.19+ or 22.12+"
          NODE_MAJOR=$(node -v | cut -d'.' -f1 | sed 's/v//')
          if [ "$NODE_MAJOR" -lt 20 ]; then
            echo "âŒ Node.js ç‰ˆæœ¬ $NODE_MAJOR ä½ŽäºŽè¦æ±‚çš„ 20"
            exit 1
          fi
          echo "âœ… Node.js ç‰ˆæœ¬éªŒè¯é€šè¿‡"

      - name: æ¸…ç†å‰ç«¯ node_modules
        working-directory: ./frontend
        run: |
          echo "åˆ é™¤æ—§çš„ node_modules ä»¥é¿å… rollup å¯é€‰ä¾èµ–é—®é¢˜..."
          rm -rf node_modules package-lock.json
          echo "âœ… æ¸…ç†å®Œæˆ"

      - name: å®‰è£…å‰ç«¯ä¾èµ–
        working-directory: ./frontend
        run: |
          echo "ä½¿ç”¨ npm install å®‰è£…ä¾èµ–..."
          npm install --no-audit --no-fund
          # æ˜¾å¼å®‰è£… rollup åŽŸç”Ÿæ¨¡å—ä»¥è§£å†³å¯é€‰ä¾èµ–é—®é¢˜
          echo "æ˜¾å¼å®‰è£… @rollup/rollup-linux-x64-gnu..."
          npm install --no-save --no-audit --no-fund @rollup/rollup-linux-x64-gnu || echo "Optional dependency installation skipped"

      - name: ä»£ç æ£€æŸ¥ (ESLint)
        working-directory: ./frontend
        run: npm run lint
        continue-on-error: true

      - name: æž„å»ºå‰ç«¯
        working-directory: ./frontend
        env:
          VITE_API_BASE_URL: /api/v1
        run: npm run build

      - name: ä¸Šä¼ æž„å»ºäº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: frontend-dist
          path: frontend/dist
          retention-days: 7

  # å®‰å…¨æ‰«æ
  security-scan:
    name: å®‰å…¨æ‰«æ
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write
      actions: read

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: è¿è¡Œ Trivy æ¼æ´žæ‰«æ
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-results.sarif'
          severity: 'CRITICAL,HIGH'

      - name: ä¸Šä¼ æ‰«æç»“æžœåˆ° GitHub Security
        uses: github/codeql-action/upload-sarif@v2
        if: always()
        with:
          sarif_file: 'trivy-results.sarif'

  # Python SDK æ£€æŸ¥
  python-sdk-check:
    name: Python SDK æ£€æŸ¥
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./media_parser_sdk

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: è®¾ç½® Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          cache: 'pip'

      - name: å®‰è£…ä¾èµ–
        run: |
          pip install -e .
          pip install pytest pytest-cov flake8

      - name: ä»£ç æ£€æŸ¥ (flake8)
        run: flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics
        continue-on-error: true

      - name: è¿è¡Œæµ‹è¯•
        run: pytest tests/ -v --cov=. --cov-report=xml
        continue-on-error: true

  # æ±‡æ€»çŠ¶æ€
  ci-summary:
    name: CI æ±‡æ€»
    runs-on: ubuntu-latest
    needs: [backend-test, frontend-test, security-scan, python-sdk-check]
    if: always()

    steps:
      - name: ç”Ÿæˆ CI æ±‡æ€»æŠ¥å‘Š
        run: |
          echo "## CI æµç¨‹æ‰§è¡Œç»“æžœ ðŸ“Š" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ä»»åŠ¡çŠ¶æ€" >> $GITHUB_STEP_SUMMARY
          echo "- åŽç«¯æµ‹è¯•: ${{ needs.backend-test.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- å‰ç«¯æµ‹è¯•: ${{ needs.frontend-test.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- å®‰å…¨æ‰«æ: ${{ needs.security-scan.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Python SDK: ${{ needs.python-sdk-check.result }}" >> $GITHUB_STEP_SUMMARY

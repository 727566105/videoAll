name: Dependency Update

on:
  schedule:
    # æ¯å‘¨ä¸€æ—©ä¸Š8ç‚¹æ£€æŸ¥ä¾èµ–æ›´æ–°
    - cron: "0 8 * * 1"
  workflow_dispatch:

jobs:
  update-dependencies:
    name: Update Dependencies
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22.x"
          cache: "npm"
          cache-dependency-path: |
            backend/package-lock.json
            frontend/package-lock.json

      # æ›´æ–°åç«¯ä¾èµ–
      - name: Update backend dependencies
        working-directory: ./backend
        run: |
          npm update
          npm audit fix --force || true

      # æ›´æ–°å‰ç«¯ä¾èµ–
      - name: Update frontend dependencies
        working-directory: ./frontend
        run: |
          npm update
          npm audit fix --force || true

      # è¿è¡Œæµ‹è¯•ç¡®ä¿æ›´æ–°æ²¡æœ‰ç ´ååŠŸèƒ½
      - name: Run tests
        run: |
          cd backend && npm test || echo "Backend tests failed"
          cd ../frontend && npm run build || echo "Frontend build failed"

      # åˆ›å»ºPR
      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "chore: update dependencies"
          title: "ğŸ”„ è‡ªåŠ¨ä¾èµ–æ›´æ–°"
          body: |
            ## ğŸ“¦ ä¾èµ–æ›´æ–°

            è¿™æ˜¯ä¸€ä¸ªè‡ªåŠ¨ç”Ÿæˆçš„PRï¼Œç”¨äºæ›´æ–°é¡¹ç›®ä¾èµ–ã€‚

            ### æ›´æ–°å†…å®¹
            - æ›´æ–°äº†æ‰€æœ‰å¯ç”¨çš„ä¾èµ–åŒ…
            - ä¿®å¤äº†å·²çŸ¥çš„å®‰å…¨æ¼æ´

            ### éªŒè¯
            - [ ] åç«¯æµ‹è¯•é€šè¿‡
            - [ ] å‰ç«¯æ„å»ºæˆåŠŸ
            - [ ] æ‰‹åŠ¨æµ‹è¯•æ ¸å¿ƒåŠŸèƒ½

            è¯·ä»”ç»†æ£€æŸ¥æ›´æ”¹å¹¶è¿›è¡Œå¿…è¦çš„æµ‹è¯•ã€‚
          branch: dependency-updates
          delete-branch: true

# 哔哩哔哩画质偏好配置功能 - 使用指南

## ✅ 功能已实现完成

### 访问页面
1. 登录系统后，点击侧边栏的 **"下载设置"** 菜单（📥 图标）
2. 或直接访问：`http://localhost:5173/download-settings`

### 功能说明

#### 1. 页面布局
- **哔哩哔哩画质配置卡片**
  - 偏好画质选择器（6种画质选项）
  - 自动降级开关
  - 保存设置按钮
  - 显示当前配置的画质

#### 2. 画质选项
| 画质 | 说明 | 权限 |
|------|------|------|
| 4K 超清 | 3840x2160 | 👑 大会员专享 |
| 1080P+ 高码率 | 1920x1080 高码率 | 👑 大会员专享 |
| 1080P 高清 | 1920x1080 | 推荐 |
| 720P 清晰 | 1280x720 | 所有用户 |
| 480P 标清 | 854x480 | 所有用户 |
| 360P 流畅 | 640x360 | 所有用户 |

#### 3. 智能特性
- **自动降级**：当选择的画质不可用时，自动尝试更低画质
  - 例如：选择4K但账号不是大会员 → 自动降级到1080P+
  - SDK内置降级机制：4K → 1080P+ → 1080P → 720P → 480P → 360P

- **智能提示**：
  - 大会员画质标注金色"👑 大会员"标签
  - 推荐画质标注蓝色"推荐"标签
  - 设置保存后提示"下次解析生效"

### 使用流程

#### 配置画质
1. 访问"下载设置"页面
2. 在"偏好画质"下拉框中选择想要的画质
3. 确认"自动降级"开关已开启（推荐）
4. 点击"保存设置"按钮
5. 看到"设置已保存，下次解析时生效"提示

#### 解析视频
1. 切换到"单作品解析"页面
2. 输入哔哩哔哩视频链接
3. 点击"开始解析"
4. 后端自动应用你配置的画质偏好
5. 查看后端日志确认：`使用偏好画质: 4K`

### 数据存储

#### 存储位置
- **数据库表**：`platform_cookies`
- **字段**：`preferences`（JSON类型）
- **数据结构**：
  ```json
  {
    "bilibili": {
      "preferred_quality": "4K",
      "auto_fallback": true
    }
  }
  ```

#### 与Cookie配置的关系
- 下载设置保存在平台Cookie配置中
- 每个平台的设置独立存储
- 如果有多个同一平台的Cookie，使用最新的配置

### 常见问题

#### Q1: 为什么显示"获取下载设置失败"？
**A**: 可能的原因：
1. 未登录系统 - 请先登录
2. 后端服务未启动 - 检查后端是否运行在3000端口
3. 网络连接问题 - 检查浏览器控制台的错误信息

**解决方案**：
- 确保已登录系统
- 刷新页面重试
- 即使获取失败，页面也会使用默认配置（1080P）

#### Q2: 配置4K后下载的还是1080P？
**A**: 可能的原因：
1. Cookie不是大会员账号
2. 该视频不支持4K
3. Cookie已失效

**解决方案**：
- 确保Cookie是大会员账号
- 检查Cookie是否有效（在"系统配置"→"平台账户配置"中测试）
- 查看后端日志确认降级过程

#### Q3: 如何确认配置已生效？
**A**:
1. 查看后端日志，应该显示：`使用偏好画质: 4K`
2. 解析成功后，检查下载的视频文件分辨率
3. 在"内容管理"页面查看视频信息

#### Q4: 需要先配置哔哩哔哩Cookie吗？
**A**: 是的，推荐配置：
1. 先在"系统配置"→"平台账户配置"中添加哔哩哔哩Cookie
2. 确保Cookie有效（点击"测试"按钮）
3. 然后在"下载设置"中配置画质偏好
4. 解析视频时会自动使用Cookie和画质配置

#### Q5: 普通用户能配置4K吗？
**A**:
- 可以配置，但解析时会自动降级到1080P
- 系统会显示"使用偏好画质: 4K"，但实际返回1080P
- 建议普通用户选择1080P或720P

### 技术细节

#### 后端实现
- **控制器**：`DownloadSettingsController.js`
- **路由**：`/api/v1/config/download-settings`
- **权限**：
  - GET：需要登录（所有用户）
  - PUT：需要admin权限
  - GET quality-options：公开接口

#### 前端实现
- **页面组件**：`DownloadSettings.jsx`
- **画质组件**：`BilibiliQualitySettings.jsx`
- **路由**：`/download-settings`

#### Python SDK
- **解析器**：`BilibiliEnhancedParser`
- **参数**：`preferred_quality`
- **降级**：自动降级机制已内置

### 测试建议

#### 测试场景1：普通用户
1. 不配置Cookie或使用普通Cookie
2. 设置画质为4K
3. 解析视频
4. 预期：自动降级到1080P

#### 测试场景2：大会员用户
1. 配置大会员Cookie
2. 设置画质为4K
3. 解析支持4K的视频
4. 预期：成功获取4K视频

#### 测试场景3：无Cookie
1. 不配置Cookie
2. 设置画质为1080P
3. 解析视频
4. 预期：使用公开画质（可能只有480P或720P）

### 更新日志

#### v1.0.0 (2025-12-27)
- ✅ 实现哔哩哔哩画质偏好配置功能
- ✅ 支持6种画质选项
- ✅ 自动降级机制
- ✅ 独立的下载设置页面
- ✅ 数据库preferences字段
- ✅ 后端API和前端UI完整实现

### 下一步优化

1. **更多平台支持**：
   - 抖音画质配置
   - 小红书画质配置
   - 其他平台偏好设置

2. **高级功能**：
   - 视频格式选择（MP4、FLV）
   - 音频质量选择
   - 下载路径配置

3. **用户体验**：
   - 画质预览功能
   - 账号类型自动检测
   - 智能推荐画质

---

**注意**：本功能需要配合哔哩哔哩Cookie使用，建议先配置有效的Cookie再进行画质设置。

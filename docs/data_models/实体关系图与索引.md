# å®ä½“å…³ç³»å›¾ä¸ç´¢å¼•

## ğŸ“Š å®ä½“å…³ç³»å›¾

### æ ¸å¿ƒå®ä½“å…³ç³»

```
User (ç”¨æˆ·)
  â†“ 1:N
CrawlTask (çˆ¬å–ä»»åŠ¡)
  â†“ 1:N
Content (å†…å®¹)
  â†“ 1:N  â†” N:1  â†” N:M
AiAnalysisResult â† Content â†’ Tag (é€šè¿‡ ContentTag)
  â†‘
AiConfig (AIé…ç½®)

HotsearchSnapshot (çƒ­æœå¿«ç…§)
- ç‹¬ç«‹å®ä½“ï¼ŒæŒ‰å¹³å°å’Œæ—¥æœŸç´¢å¼•

PlatformCookie (å¹³å°Cookie)
- ç‹¬ç«‹å®ä½“ï¼ŒæŒ‰å¹³å°å’Œæœ‰æ•ˆæ€§ç´¢å¼•

SystemSettings (ç³»ç»Ÿè®¾ç½®)
- å•ä¾‹å®ä½“ï¼Œå…¨å±€å”¯ä¸€é…ç½®

TaskLog (ä»»åŠ¡æ—¥å¿—)
  â†“ N:1
CrawlTask
```

---

## å®ä½“åˆ—è¡¨

### æ ¸å¿ƒä¸šåŠ¡å®ä½“

1. **[Content å®ä½“](./Content_å®ä½“.md)** - å†…å®¹å…ƒæ•°æ®
2. **[User å®ä½“](./User_å®ä½“.md)** - ç”¨æˆ·è´¦æˆ·
3. **CrawlTask å®ä½“** - çˆ¬å–ä»»åŠ¡
4. **HotsearchSnapshot å®ä½“** - çƒ­æœå¿«ç…§
5. **AiConfig å®ä½“** - AIé…ç½®

### å…³è”å®ä½“

6. **AiAnalysisResult å®ä½“** - AIåˆ†æç»“æœ
7. **PlatformCookie å®ä½“** - å¹³å°Cookie
8. **Tag å®ä½“** - æ ‡ç­¾
9. **ContentTag å®ä½“** - å†…å®¹æ ‡ç­¾å…³è”
10. **TaskLog å®ä½“** - ä»»åŠ¡æ—¥å¿—

### ç³»ç»Ÿå®ä½“

11. **SystemSettings å®ä½“** - ç³»ç»Ÿè®¾ç½®
12. **PlatformAccount å®ä½“** - å¹³å°è´¦æˆ·
13. **AiTestHistory å®ä½“** - AIæµ‹è¯•å†å²

---

## å…³é”®ç´¢å¼•

### å”¯ä¸€ç´¢å¼•

| å®ä½“ | ç´¢å¼•å | å­—æ®µ | ä½œç”¨ |
|------|--------|------|------|
| Content | IDX_CONTENT_PLATFORM_CONTENT_ID | platform + content_id | é˜²æ­¢é‡å¤å†…å®¹ |
| User | IDX_USER_USERNAME | username | ç”¨æˆ·åå”¯ä¸€ |
| HotsearchSnapshot | IDX_HOTSEARCH_PLATFORM_DATE | platform + capture_date | é˜²æ­¢é‡å¤å¿«ç…§ |
| Tag | IDX_TAG_NAME | name | æ ‡ç­¾åå”¯ä¸€ |
| ContentTag | IDX_CONTENT_TAG_UNIQUE | content_id + tag_id | é˜²æ­¢é‡å¤å…³è” |

### æŸ¥è¯¢ä¼˜åŒ–ç´¢å¼•

| å®ä½“ | ç´¢å¼•å | å­—æ®µ | ä½œç”¨ |
|------|--------|------|------|
| CrawlTask | IDX_CRAWL_TASK_PLATFORM | platform | æŒ‰å¹³å°æŸ¥è¯¢ |
| CrawlTask | IDX_CRAWL_TASK_STATUS | status | æŒ‰çŠ¶æ€ç­›é€‰ |
| AiConfig | IDX_AI_CONFIG_ENABLED | is_enabled | æŸ¥è¯¢å¯ç”¨çš„é…ç½® |
| TaskLog | IDX_TASK_LOG_START_TIME | start_time + status | æ—¶é—´èŒƒå›´æŸ¥è¯¢ |

---

## å…³ç³»ç±»å‹è¯´æ˜

### ä¸€å¯¹å¤šï¼ˆ1:Nï¼‰

- **User â†’ CrawlTask**: ä¸€ä¸ªç”¨æˆ·å¯ä»¥åˆ›å»ºå¤šä¸ªä»»åŠ¡
- **CrawlTask â†’ Content**: ä¸€ä¸ªä»»åŠ¡å¯ä»¥é‡‡é›†å¤šä¸ªå†…å®¹
- **CrawlTask â†’ TaskLog**: ä¸€ä¸ªä»»åŠ¡å¯ä»¥æœ‰å¤šæ¡æ—¥å¿—
- **AiConfig â†’ AiAnalysisResult**: ä¸€ä¸ªé…ç½®å¯ä»¥äº§ç”Ÿå¤šä¸ªåˆ†æç»“æœ
- **Content â†’ AiAnalysisResult**: ä¸€ä¸ªå†…å®¹å¯ä»¥æœ‰å¤šä¸ªAIåˆ†æç»“æœ

### å¤šå¯¹å¤šï¼ˆN:Mï¼‰

- **Content â†” Tag**: å†…å®¹å’Œæ ‡ç­¾æ˜¯å¤šå¯¹å¤šå…³ç³»
- **ä¸­é—´è¡¨**: ContentTag
- **å…³è”å­—æ®µ**: content_id, tag_id

---

## å¤–é”®å…³ç³»

| å®ä½“ | å¤–é”®å­—æ®µ | å…³è”å®ä½“ | çº§è”è§„åˆ™ |
|------|---------|---------|---------|
| Content | task_id | CrawlTask | SET NULL |
| AiAnalysisResult | content_id | Content | CASCADE |
| AiAnalysisResult | ai_config_id | AiConfig | SET NULL |
| AiTestHistory | ai_config_id | AiConfig | CASCADE |
| ContentTag | content_id | Content | CASCADE |
| ContentTag | tag_id | Tag | CASCADE |
| TaskLog | task_id | CrawlTask | SET NULL |

---

## æ•°æ®å®Œæ•´æ€§

### çº§è”åˆ é™¤ï¼ˆCASCADEï¼‰

- åˆ é™¤ Content â†’ åˆ é™¤ç›¸å…³çš„ AiAnalysisResult
- åˆ é™¤ AiConfig â†’ åˆ é™¤ç›¸å…³çš„ AiTestHistory
- åˆ é™¤ Content â†’ åˆ é™¤ç›¸å…³çš„ ContentTag å…³è”

### è®¾ç½®ç©ºï¼ˆSET NULLï¼‰

- åˆ é™¤ CrawlTask â†’ Content.task_id è®¾ä¸º NULL
- åˆ é™¤ AiConfig â†’ AiAnalysisResult.ai_config_id è®¾ä¸º NULL

---

## æŸ¥è¯¢ä¼˜åŒ–å»ºè®®

### å¸¸è§æŸ¥è¯¢æ¨¡å¼

1. **æŒ‰å¹³å°æŸ¥è¯¢å†…å®¹**
   ```sql
   WHERE platform = 'xiaohongshu'
   ä½¿ç”¨ç´¢å¼•: IDX_CONTENT_PLATFORM_CONTENT_ID
   ```

2. **æŒ‰æ—¶é—´èŒƒå›´æŸ¥è¯¢**
   ```sql
   WHERE created_at >= ? AND created_at <= ?
   ä½¿ç”¨ç´¢å¼•: created_at å­—æ®µä¸Šçš„ç´¢å¼•
   ```

3. **æŒ‰æ ‡ç­¾æŸ¥è¯¢å†…å®¹**
   ```sql
   é€šè¿‡ ContentTag ä¸­é—´è¡¨
   ä½¿ç”¨ç´¢å¼•: IDX_CONTENT_TAG_CONTENT, IDX_CONTENT_TAG_TAG
   ```

---

## ç›¸å…³æ–‡æ¡£

- [æ•°æ®åº“æ¶æ„](../../README.md#æ•°æ®åº“æ¶æ„)
- [API æ¨¡å—ç´¢å¼•](../modules/)

---

**æœ€åæ›´æ–°**: 2025-12-28

# é”™è¯¯å¤„ç†ä¸çŠ¶æ€ç 

æœ¬æ–‡æ¡£è¯¦ç»†è¯´æ˜ API çš„é”™è¯¯å¤„ç†æœºåˆ¶ã€HTTP çŠ¶æ€ç åŠé”™è¯¯å“åº”æ ¼å¼ã€‚

---

## ğŸ“‹ ç›®å½•

1. [HTTP çŠ¶æ€ç ](#http-çŠ¶æ€ç )
2. [æ ‡å‡†å“åº”æ ¼å¼](#æ ‡å‡†å“åº”æ ¼å¼)
3. [é”™è¯¯å¤„ç†æµç¨‹](#é”™è¯¯å¤„ç†æµç¨‹)
4. [å¸¸è§é”™è¯¯åœºæ™¯](#å¸¸è§é”™è¯¯åœºæ™¯)
5. [å®¢æˆ·ç«¯é”™è¯¯å¤„ç†å»ºè®®](#å®¢æˆ·ç«¯é”™è¯¯å¤„ç†å»ºè®®)

---

## HTTP çŠ¶æ€ç 

ç³»ç»Ÿä½¿ç”¨æ ‡å‡† HTTP çŠ¶æ€ç è¡¨ç¤ºè¯·æ±‚çš„å¤„ç†ç»“æœã€‚

### 2xx - æˆåŠŸå“åº”

| çŠ¶æ€ç  | å«ä¹‰ | ä½¿ç”¨åœºæ™¯ |
|--------|------|----------|
| **200 OK** | è¯·æ±‚æˆåŠŸ | GETã€PUTã€PATCH è¯·æ±‚æˆåŠŸ |
| **201 Created** | åˆ›å»ºæˆåŠŸ | POST è¯·æ±‚åˆ›å»ºèµ„æºæˆåŠŸ |
| **204 No Content** | æ— å†…å®¹ | DELETE è¯·æ±‚åˆ é™¤æˆåŠŸï¼Œæ— éœ€è¿”å›å†…å®¹ |

**ç¤ºä¾‹**ï¼š
```bash
# 200 OK - è·å–ç”¨æˆ·ä¿¡æ¯
GET /api/v1/users/me
HTTP 200 OK

# 201 Created - åˆ›å»ºç”¨æˆ·
POST /api/v1/users
HTTP 201 Created

# 204 No Content - åˆ é™¤ç”¨æˆ·
DELETE /api/v1/users/:id
HTTP 204 No Content
```

---

### 4xx - å®¢æˆ·ç«¯é”™è¯¯

| çŠ¶æ€ç  | å«ä¹‰ | ä½¿ç”¨åœºæ™¯ | è§£å†³æ–¹æ¡ˆ |
|--------|------|----------|----------|
| **400 Bad Request** | è¯·æ±‚é”™è¯¯ | å‚æ•°ç¼ºå¤±ã€æ ¼å¼é”™è¯¯ã€ç±»å‹ä¸æ­£ç¡® | æ£€æŸ¥è¯·æ±‚å‚æ•° |
| **401 Unauthorized** | æœªè®¤è¯ | Token ç¼ºå¤±ã€æ— æ•ˆæˆ–è¿‡æœŸ | é‡æ–°ç™»å½•è·å– Token |
| **403 Forbidden** | æƒé™ä¸è¶³ | è§’è‰²æƒé™ä¸å¤Ÿï¼Œå¦‚éç®¡ç†å‘˜è®¿é—®ç®¡ç†å‘˜æ¥å£ | è”ç³»ç®¡ç†å‘˜æˆæƒ |
| **404 Not Found** | èµ„æºä¸å­˜åœ¨ | è¯·æ±‚çš„èµ„æºï¼ˆç”¨æˆ·ã€å†…å®¹ç­‰ï¼‰ä¸å­˜åœ¨ | æ£€æŸ¥èµ„æº ID |
| **422 Unprocessable Entity** | æ— æ³•å¤„ç† | å‚æ•°æ ¼å¼æ­£ç¡®ä½†è¯­ä¹‰é”™è¯¯ï¼ˆå¦‚é‚®ç®±å·²å­˜åœ¨ï¼‰ | ä¿®æ”¹è¯·æ±‚å‚æ•° |
| **429 Too Many Requests** | è¯·æ±‚è¿‡å¤š | è¶…è¿‡é€Ÿç‡é™åˆ¶ | ç­‰å¾…åé‡è¯• |

**ç¤ºä¾‹**ï¼š
```bash
# 400 Bad Request - ç¼ºå°‘å¿…å¡«å‚æ•°
POST /api/v1/content/parse
HTTP 400 Bad Request
{
  "message": "è¯·æä¾›ä½œå“é“¾æ¥"
}

# 401 Unauthorized - Token æ— æ•ˆ
GET /api/v1/users/me
HTTP 401 Unauthorized
{
  "message": "Unauthorized: Invalid token"
}

# 403 Forbidden - æƒé™ä¸è¶³
DELETE /api/v1/users/:id
HTTP 403 Forbidden
{
  "message": "Forbidden: Admin access required"
}

# 404 Not Found - ç”¨æˆ·ä¸å­˜åœ¨
GET /api/v1/users/non-existent-id
HTTP 404 Not Found
{
  "message": "ç”¨æˆ·ä¸å­˜åœ¨"
}

# 429 Too Many Requests - è¶…è¿‡é€Ÿç‡é™åˆ¶
GET /api/v1/content/
HTTP 429 Too Many Requests
{
  "status": "error",
  "message": "è¯·æ±‚è¿‡äºé¢‘ç¹ï¼Œè¯·ç¨åé‡è¯•",
  "code": 429
}
```

---

### 5xx - æœåŠ¡å™¨é”™è¯¯

| çŠ¶æ€ç  | å«ä¹‰ | ä½¿ç”¨åœºæ™¯ | è§£å†³æ–¹æ¡ˆ |
|--------|------|----------|----------|
| **500 Internal Server Error** | æœåŠ¡å™¨å†…éƒ¨é”™è¯¯ | æœªæ•è·çš„å¼‚å¸¸ã€æ•°æ®åº“é”™è¯¯ | è”ç³»åç«¯å›¢é˜Ÿ |
| **503 Service Unavailable** | æœåŠ¡ä¸å¯ç”¨ | æ•°æ®åº“è¿æ¥å¤±è´¥ã€ä¾èµ–æœåŠ¡ä¸å¯ç”¨ | ç¨åé‡è¯•æˆ–è”ç³»è¿ç»´ |

**ç¤ºä¾‹**ï¼š
```bash
# 500 Internal Server Error - è§£æå¤±è´¥
POST /api/v1/content/parse
HTTP 500 Internal Server Error
{
  "message": "è§£æå¤±è´¥: ç½‘ç»œè¿æ¥è¶…æ—¶"
}

# 503 Service Unavailable - æ•°æ®åº“è¿æ¥å¤±è´¥
GET /api/v1/content/
HTTP 503 Service Unavailable
{
  "message": "æœåŠ¡æš‚æ—¶ä¸å¯ç”¨ï¼Œè¯·ç¨åé‡è¯•"
}
```

---

## æ ‡å‡†å“åº”æ ¼å¼

### æˆåŠŸå“åº”æ ¼å¼

#### å•ä¸ªèµ„æºå“åº”ï¼ˆ200/201ï¼‰

```json
{
  "message": "æ“ä½œæˆåŠŸ",
  "data": {
    "id": "550e8400-e29b-41d4-a716-446655440000",
    "title": "å†…å®¹æ ‡é¢˜",
    "author": "ä½œè€…åç§°",
    ...
  },
  "timestamp": "2025-12-28T12:00:00.000Z"
}
```

**å­—æ®µè¯´æ˜**ï¼š
- `message`: å“åº”æ¶ˆæ¯
- `data`: ä¸šåŠ¡æ•°æ®
- `timestamp`: æœåŠ¡å™¨æ—¶é—´æˆ³

#### åˆ—è¡¨åˆ†é¡µå“åº”ï¼ˆ200ï¼‰

```json
{
  "message": "è·å–æˆåŠŸ",
  "data": [
    { "id": "1", "title": "å†…å®¹1" },
    { "id": "2", "title": "å†…å®¹2" }
  ],
  "pagination": {
    "total": 100,
    "page": 1,
    "pageSize": 20,
    "totalPages": 5
  },
  "timestamp": "2025-12-28T12:00:00.000Z"
}
```

**åˆ†é¡µå­—æ®µè¯´æ˜**ï¼š
- `total`: æ€»è®°å½•æ•°
- `page`: å½“å‰é¡µç 
- `pageSize`: æ¯é¡µæ•°é‡
- `totalPages`: æ€»é¡µæ•°

#### æ— å†…å®¹å“åº”ï¼ˆ204ï¼‰

```
HTTP 204 No Content
```

æ— å“åº”ä½“ï¼Œä»…è¿”å›çŠ¶æ€ç ã€‚

---

### é”™è¯¯å“åº”æ ¼å¼

#### æ ‡å‡†é”™è¯¯å“åº”ï¼ˆ4xx/5xxï¼‰

```json
{
  "message": "é”™è¯¯æè¿°",
  "error": "è¯¦ç»†é”™è¯¯ä¿¡æ¯ï¼ˆå¯é€‰ï¼‰",
  "code": 400,
  "timestamp": "2025-12-28T12:00:00.000Z"
}
```

**å­—æ®µè¯´æ˜**ï¼š
- `message`: ç”¨æˆ·å‹å¥½çš„é”™è¯¯æè¿°
- `error`: è¯¦ç»†é”™è¯¯ä¿¡æ¯ï¼ˆå¯é€‰ï¼Œä»…å¼€å‘ç¯å¢ƒï¼‰
- `code`: ä¸šåŠ¡é”™è¯¯ç ï¼ˆå¯é€‰ï¼‰
- `timestamp`: æœåŠ¡å™¨æ—¶é—´æˆ³

#### é€Ÿç‡é™åˆ¶é”™è¯¯ï¼ˆ429ï¼‰

```json
{
  "status": "error",
  "message": "è¯·æ±‚è¿‡äºé¢‘ç¹ï¼Œè¯·ç¨åé‡è¯•",
  "code": 429
}
```

---

## é”™è¯¯å¤„ç†æµç¨‹

### åç«¯é”™è¯¯å¤„ç†æµç¨‹

```javascript
// æ§åˆ¶å™¨ä¸­çš„é”™è¯¯å¤„ç†
try {
  // 1. éªŒè¯è¯·æ±‚å‚æ•°
  const { link } = req.body;
  if (!link) {
    return res.status(400).json({ message: 'è¯·æä¾›ä½œå“é“¾æ¥' });
  }

  // 2. æ‰§è¡Œä¸šåŠ¡é€»è¾‘
  const result = await ParseService.parseLink(link);

  // 3. è¿”å›æˆåŠŸå“åº”
  res.status(201).json({
    message: 'è§£ææˆåŠŸ',
    data: result
  });

} catch (error) {
  console.error('Parse error:', error);

  // 4. è¿”å›é”™è¯¯å“åº”
  res.status(500).json({
    message: 'è§£æå¤±è´¥',
    error: error.message
  });
}
```

### å‰ç«¯é”™è¯¯å¤„ç†æµç¨‹

```javascript
// Axios å“åº”æ‹¦æˆªå™¨
api.interceptors.response.use(
  (response) => {
    // 2xx æˆåŠŸå“åº”
    return response.data;
  },
  (error) => {
    // 4xx/5xx é”™è¯¯å“åº”
    const { status, data } = error.response;

    switch (status) {
      case 400:
        console.error('è¯·æ±‚å‚æ•°é”™è¯¯:', data.message);
        break;
      case 401:
        console.error('è®¤è¯å¤±è´¥ï¼Œè¯·é‡æ–°ç™»å½•');
        // è·³è½¬åˆ°ç™»å½•é¡µ
        window.location.href = '/login';
        break;
      case 403:
        console.error('æƒé™ä¸è¶³');
        break;
      case 404:
        console.error('èµ„æºä¸å­˜åœ¨');
        break;
      case 429:
        console.error('è¯·æ±‚è¿‡äºé¢‘ç¹');
        break;
      case 500:
        console.error('æœåŠ¡å™¨é”™è¯¯:', data.message);
        break;
      default:
        console.error('æœªçŸ¥é”™è¯¯');
    }

    return Promise.reject(error);
  }
);
```

---

## å¸¸è§é”™è¯¯åœºæ™¯

### 1. è®¤è¯ç›¸å…³é”™è¯¯

#### 401 Unauthorized - Token ç¼ºå¤±

**è¯·æ±‚**ï¼š
```bash
curl -X GET "http://localhost:3000/api/v1/users/me"
```

**å“åº”**ï¼š
```json
{
  "message": "Unauthorized: No token provided"
}
```

**åŸå› **ï¼šè¯·æ±‚å¤´æœªæºå¸¦ Token

**è§£å†³æ–¹æ¡ˆ**ï¼š
```bash
curl -X GET "http://localhost:3000/api/v1/users/me" \
  -H "Authorization: Bearer <your-token>"
```

---

#### 401 Unauthorized - Token æ— æ•ˆ

**è¯·æ±‚**ï¼š
```bash
curl -X GET "http://localhost:3000/api/v1/users/me" \
  -H "Authorization: Bearer invalid-token"
```

**å“åº”**ï¼š
```json
{
  "message": "Unauthorized: Invalid token"
}
```

**åŸå› **ï¼šToken æ ¼å¼é”™è¯¯æˆ–ç­¾åæ— æ•ˆ

**è§£å†³æ–¹æ¡ˆ**ï¼šé‡æ–°ç™»å½•è·å–æœ‰æ•ˆ Token

---

#### 401 Unauthorized - Token è¿‡æœŸ

**å“åº”**ï¼š
```json
{
  "message": "Tokenå·²è¿‡æœŸ"
}
```

**åŸå› **ï¼šToken è¶…è¿‡æœ‰æ•ˆæœŸï¼ˆé»˜è®¤7å¤©ï¼‰

**è§£å†³æ–¹æ¡ˆ**ï¼šé‡æ–°ç™»å½•è·å–æ–° Token

---

### 2. æƒé™ç›¸å…³é”™è¯¯

#### 403 Forbidden - æƒé™ä¸è¶³

**åœºæ™¯**ï¼šOperator è§’è‰²å°è¯•è®¿é—®ç®¡ç†å‘˜æ¥å£

**è¯·æ±‚**ï¼š
```bash
curl -X DELETE "http://localhost:3000/api/v1/users/:id" \
  -H "Authorization: Bearer <operator-token>"
```

**å“åº”**ï¼š
```json
{
  "message": "Forbidden: Admin access required"
}
```

**åŸå› **ï¼šç”¨æˆ·è§’è‰²æƒé™ä¸è¶³

**è§£å†³æ–¹æ¡ˆ**ï¼šä½¿ç”¨ç®¡ç†å‘˜è´¦å·æ“ä½œ

---

### 3. å‚æ•°ç›¸å…³é”™è¯¯

#### 400 Bad Request - å‚æ•°ç¼ºå¤±

**è¯·æ±‚**ï¼š
```bash
curl -X POST "http://localhost:3000/api/v1/content/parse" \
  -H "Content-Type: application/json" \
  -d '{}'
```

**å“åº”**ï¼š
```json
{
  "message": "è¯·æä¾›ä½œå“é“¾æ¥"
}
```

**åŸå› **ï¼šç¼ºå°‘å¿…å¡«å‚æ•° `link`

**è§£å†³æ–¹æ¡ˆ**ï¼š
```bash
curl -X POST "http://localhost:3000/api/v1/content/parse" \
  -H "Content-Type: application/json" \
  -d '{"link": "https://www.xiaohongshu.com/..."}'
```

---

#### 400 Bad Request - å‚æ•°æ ¼å¼é”™è¯¯

**è¯·æ±‚**ï¼š
```bash
curl -X POST "http://localhost:3000/api/v1/auth/login" \
  -H "Content-Type: application/json" \
  -d '{"email": "invalid-email", "password": "123"}'
```

**å“åº”**ï¼š
```json
{
  "message": "é‚®ç®±æ ¼å¼ä¸æ­£ç¡®"
}
```

**åŸå› **ï¼šå‚æ•°æ ¼å¼ä¸ç¬¦åˆè¦æ±‚

**è§£å†³æ–¹æ¡ˆ**ï¼šæä¾›æ­£ç¡®æ ¼å¼çš„å‚æ•°

---

### 4. èµ„æºç›¸å…³é”™è¯¯

#### 404 Not Found - ç”¨æˆ·ä¸å­˜åœ¨

**è¯·æ±‚**ï¼š
```bash
curl -X GET "http://localhost:3000/api/v1/users/non-existent-id"
```

**å“åº”**ï¼š
```json
{
  "message": "ç”¨æˆ·ä¸å­˜åœ¨"
}
```

**åŸå› **ï¼šè¯·æ±‚çš„èµ„æºä¸å­˜åœ¨

**è§£å†³æ–¹æ¡ˆ**ï¼šæ£€æŸ¥èµ„æº ID æ˜¯å¦æ­£ç¡®

---

### 5. ä¸šåŠ¡é€»è¾‘é”™è¯¯

#### 409 Conflict - é‚®ç®±å·²å­˜åœ¨

**è¯·æ±‚**ï¼š
```bash
curl -X POST "http://localhost:3000/api/v1/users" \
  -H "Content-Type: application/json" \
  -d '{"email": "admin@example.com", "password": "123"}'
```

**å“åº”**ï¼š
```json
{
  "message": "é‚®ç®±å·²è¢«æ³¨å†Œ"
}
```

**åŸå› **ï¼šä¸šåŠ¡è§„åˆ™å†²çªï¼ˆå¦‚é‚®ç®±å”¯ä¸€æ€§çº¦æŸï¼‰

**è§£å†³æ–¹æ¡ˆ**ï¼šä½¿ç”¨å…¶ä»–é‚®ç®±

---

### 6. æœåŠ¡å™¨é”™è¯¯

#### 500 Internal Server Error - è§£æå¤±è´¥

**è¯·æ±‚**ï¼š
```bash
curl -X POST "http://localhost:3000/api/v1/content/parse" \
  -H "Content-Type: application/json" \
  -d '{"link": "https://invalid-url"}'
```

**å“åº”**ï¼š
```json
{
  "message": "è§£æå¤±è´¥: ä¸æ”¯æŒçš„å¹³å°é“¾æ¥"
}
```

**åŸå› **ï¼šåç«¯å¤„ç†å¼‚å¸¸ï¼ˆç½‘ç»œé”™è¯¯ã€å¹³å°ä¸æ”¯æŒç­‰ï¼‰

**è§£å†³æ–¹æ¡ˆ**ï¼š
1. æ£€æŸ¥é“¾æ¥æ ¼å¼å’Œå¹³å°æ”¯æŒ
2. æŸ¥çœ‹åç«¯æ—¥å¿—ï¼š`tail -f backend/logs/error.log`
3. è”ç³»åç«¯å›¢é˜Ÿ

---

#### 503 Service Unavailable - æ•°æ®åº“è¿æ¥å¤±è´¥

**å“åº”**ï¼š
```json
{
  "message": "æœåŠ¡æš‚æ—¶ä¸å¯ç”¨ï¼Œè¯·ç¨åé‡è¯•"
}
```

**åŸå› **ï¼šæ•°æ®åº“è¿æ¥å¤±è´¥æˆ–ä¾èµ–æœåŠ¡ä¸å¯ç”¨

**è§£å†³æ–¹æ¡ˆ**ï¼š
1. ç¨åé‡è¯•
2. è”ç³»è¿ç»´æ£€æŸ¥æ•°æ®åº“çŠ¶æ€

---

### 7. é€Ÿç‡é™åˆ¶é”™è¯¯

#### 429 Too Many Requests - è¶…è¿‡é€Ÿç‡é™åˆ¶

**å“åº”**ï¼š
```json
{
  "status": "error",
  "message": "è¯·æ±‚è¿‡äºé¢‘ç¹ï¼Œè¯·ç¨åé‡è¯•",
  "code": 429
}
```

**åŸå› **ï¼š15åˆ†é’Ÿå†…è¶…è¿‡100æ¬¡è¯·æ±‚

**è§£å†³æ–¹æ¡ˆ**ï¼š
1. ç­‰å¾…15åˆ†é’Ÿåé‡è¯•
2. å®ç°è¯·æ±‚é˜Ÿåˆ—å’ŒèŠ‚æµ
3. è”ç³»ç®¡ç†å‘˜è°ƒæ•´é€Ÿç‡é™åˆ¶

---

## å®¢æˆ·ç«¯é”™è¯¯å¤„ç†å»ºè®®

### 1. ç»Ÿä¸€é”™è¯¯å¤„ç†

åˆ›å»ºç»Ÿä¸€çš„é”™è¯¯å¤„ç†å·¥å…·ï¼š

```javascript
// utils/errorHandler.js
export const handleApiError = (error) => {
  const { status, data } = error.response || {};

  switch (status) {
    case 400:
      return 'è¯·æ±‚å‚æ•°é”™è¯¯ï¼Œè¯·æ£€æŸ¥è¾“å…¥';
    case 401:
      return 'ç™»å½•å·²è¿‡æœŸï¼Œè¯·é‡æ–°ç™»å½•';
    case 403:
      return 'æƒé™ä¸è¶³ï¼Œè¯·è”ç³»ç®¡ç†å‘˜';
    case 404:
      return 'è¯·æ±‚çš„èµ„æºä¸å­˜åœ¨';
    case 429:
      return 'è¯·æ±‚è¿‡äºé¢‘ç¹ï¼Œè¯·ç¨åé‡è¯•';
    case 500:
      return 'æœåŠ¡å™¨é”™è¯¯ï¼Œè¯·ç¨åé‡è¯•';
    case 503:
      return 'æœåŠ¡æš‚æ—¶ä¸å¯ç”¨';
    default:
      return data?.message || 'ç½‘ç»œé”™è¯¯ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥';
  }
};
```

### 2. ç”¨æˆ·å‹å¥½æç¤º

å°†æŠ€æœ¯é”™è¯¯è½¬æ¢ä¸ºç”¨æˆ·å‹å¥½çš„æç¤ºï¼š

```javascript
try {
  const result = await api.parseContent(link);
} catch (error) {
  const message = handleApiError(error);
  toast.error(message); // æ˜¾ç¤ºæç¤º
}
```

### 3. é”™è¯¯æ—¥å¿—è®°å½•

è®°å½•é”™è¯¯æ—¥å¿—ç”¨äºè°ƒè¯•ï¼š

```javascript
api.interceptors.response.use(
  (response) => response.data,
  (error) => {
    // è®°å½•é”™è¯¯æ—¥å¿—
    console.error('[API Error]', {
      url: error.config?.url,
      method: error.config?.method,
      status: error.response?.status,
      message: error.response?.data?.message,
      timestamp: new Date().toISOString()
    });

    return Promise.reject(error);
  }
);
```

### 4. è‡ªåŠ¨é‡è¯•æœºåˆ¶

å¯¹äºå¯é‡è¯•çš„é”™è¯¯ï¼ˆå¦‚ 429ã€503ï¼‰ï¼Œå®ç°è‡ªåŠ¨é‡è¯•ï¼š

```javascript
const retry = async (fn, retries = 3) => {
  try {
    return await fn();
  } catch (error) {
    const { status } = error.response || {};

    if (retries > 0 && [429, 503, 504].includes(status)) {
      console.log(`é‡è¯•ä¸­... å‰©ä½™æ¬¡æ•°: ${retries - 1}`);
      await new Promise(resolve => setTimeout(resolve, 1000));
      return retry(fn, retries - 1);
    }

    throw error;
  }
};
```

---

## ç›¸å…³æ–‡æ¡£

- [è®¤è¯æœºåˆ¶è¯¦è§£](./02_è®¤è¯æœºåˆ¶è¯¦è§£.md)
- [é€Ÿç‡é™åˆ¶è¯´æ˜](./04_é€Ÿç‡é™åˆ¶è¯´æ˜.md)
- [å¿«é€Ÿå¼€å§‹æŒ‡å—](./01_å¿«é€Ÿå¼€å§‹.md)

---

**æœ€åæ›´æ–°**: 2025-12-28

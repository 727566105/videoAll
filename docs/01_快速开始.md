# å¿«é€Ÿå¼€å§‹æŒ‡å—

æœ¬æŒ‡å—å°†å¸®åŠ©æ‚¨å¿«é€Ÿä¸Šæ‰‹ä½¿ç”¨å†…å®¹è§£æã€ç®¡ç†ä¸çƒ­ç‚¹å‘ç°ç³»ç»Ÿçš„ APIã€‚

---

## ğŸ“‹ ç›®å½•

1. [ç¯å¢ƒå‡†å¤‡](#ç¯å¢ƒå‡†å¤‡)
2. [å¯åŠ¨åç«¯æœåŠ¡](#å¯åŠ¨åç«¯æœåŠ¡)
3. [è®¤è¯æµç¨‹](#è®¤è¯æµç¨‹)
4. [åŸºç¡€æ¥å£è°ƒç”¨](#åŸºç¡€æ¥å£è°ƒç”¨)
5. [å¸¸è§åœºæ™¯ç¤ºä¾‹](#å¸¸è§åœºæ™¯ç¤ºä¾‹)
6. [æ•…éšœæ’æŸ¥](#æ•…éšœæ’æŸ¥)

---

## ç¯å¢ƒå‡†å¤‡

### ç³»ç»Ÿè¦æ±‚

- **Node.js**: >= 14.x
- **PostgreSQL**: >= 12.x
- **Python**: >= 3.8ï¼ˆç”¨äºå†…å®¹è§£æ SDKï¼‰
- **æ“ä½œç³»ç»Ÿ**: Windows / macOS / Linux

### ä¾èµ–å®‰è£…

#### 1. å…‹éš†é¡¹ç›®
```bash
git clone <repository-url>
cd videoAll
```

#### 2. å®‰è£…åç«¯ä¾èµ–
```bash
cd backend
npm install
```

#### 3. é…ç½®ç¯å¢ƒå˜é‡
å¤åˆ¶ `.env.example` ä¸º `.env` å¹¶é…ç½®ï¼š

```env
# æœåŠ¡å™¨é…ç½®
PORT=3000
NODE_ENV=development

# æ•°æ®åº“é…ç½®
MONGODB_URI=mongodb://localhost:27017/videoall
DB_HOST=localhost
DB_PORT=5432
DB_NAME=videoall
DB_USER=postgres
DB_PASSWORD=postgres

# JWT é…ç½®
JWT_SECRET=your-secret-key-change-this-in-production
JWT_EXPIRES_IN=7d

# å­˜å‚¨è·¯å¾„
STORAGE_ROOT_PATH=./media

# æ—¥å¿—çº§åˆ«
LOG_LEVEL=info

# é€Ÿç‡é™åˆ¶
RATE_LIMIT_WINDOW_MS=900000
RATE_LIMIT_MAX_REQUESTS=100
```

#### 4. åˆå§‹åŒ–æ•°æ®åº“
```bash
# ç¡®ä¿ PostgreSQL æ­£åœ¨è¿è¡Œ
# åˆ›å»ºæ•°æ®åº“
createdb videoall

# æˆ–ä½¿ç”¨ psql
psql -U postgres
CREATE DATABASE videoall;
\q
```

---

## å¯åŠ¨åç«¯æœåŠ¡

### å¼€å‘æ¨¡å¼ï¼ˆæ”¯æŒçƒ­é‡è½½ï¼‰
```bash
cd backend
npm run dev
```

æœåŠ¡å°†åœ¨ `http://localhost:3000` å¯åŠ¨ã€‚

### ç”Ÿäº§æ¨¡å¼
```bash
cd backend
npm run build
npm start
```

### ä½¿ç”¨ PM2ï¼ˆæ¨èç”¨äºç”Ÿäº§ï¼‰
```bash
npm install -g pm2
pm2 start backend/src/server.js --name videoall-api
pm2 list
pm2 logs videoall-api
```

### éªŒè¯æœåŠ¡è¿è¡Œ
```bash
curl http://localhost:3000/api/v1/auth/system-status
```

é¢„æœŸå“åº”ï¼š
```json
{
  "hasUsers": false,
  "userCount": 0
}
```

---

## è®¤è¯æµç¨‹

### 1. ç³»ç»Ÿåˆå§‹åŒ–ï¼ˆä»…é¦–æ¬¡ï¼‰

å¦‚æœæ˜¯å…¨æ–°å®‰è£…ï¼Œéœ€è¦åˆ›å»ºç¬¬ä¸€ä¸ªç®¡ç†å‘˜è´¦æˆ·ï¼š

**è¯·æ±‚**ï¼š
```bash
curl -X POST "http://localhost:3000/api/v1/auth/initial-setup" \
  -H "Content-Type: application/json" \
  -d '{
    "username": "admin",
    "email": "admin@example.com",
    "password": "admin123"
  }'
```

**å“åº”**ï¼ˆ201 Createdï¼‰ï¼š
```json
{
  "message": "ç³»ç»Ÿåˆå§‹åŒ–æˆåŠŸ",
  "user": {
    "id": "uuid",
    "username": "admin",
    "email": "admin@example.com",
    "role": "admin"
  },
  "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
}
```

> **æ³¨æ„**ï¼šç³»ç»Ÿåªèƒ½åˆå§‹åŒ–ä¸€æ¬¡ï¼Œåç»­è°ƒç”¨æ­¤æ¥å£ä¼šè¿”å›é”™è¯¯ã€‚

### 2. ç”¨æˆ·ç™»å½•

**è¯·æ±‚**ï¼š
```bash
curl -X POST "http://localhost:3000/api/v1/auth/login" \
  -H "Content-Type: application/json" \
  -d '{
    "email": "admin@example.com",
    "password": "admin123"
  }'
```

**å“åº”**ï¼ˆ200 OKï¼‰ï¼š
```json
{
  "message": "ç™»å½•æˆåŠŸ",
  "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpZCI6InV1aWQiLCJ1c2VybmFtZSI6ImFkbWluIiwicm9sZSI6ImFkbWluIiwiaWF0IjoxNzM1NDQzMDAwLCJleHAiOjE3MzYwNDc4MDB9.signature",
  "user": {
    "id": "uuid",
    "username": "admin",
    "email": "admin@example.com",
    "role": "admin"
  }
}
```

### 3. ä½¿ç”¨ Token

åœ¨åç»­éœ€è¦è®¤è¯çš„è¯·æ±‚ä¸­ï¼Œåœ¨è¯·æ±‚å¤´ä¸­æ·»åŠ  Tokenï¼š

```bash
curl -X GET "http://localhost:3000/api/v1/users/me" \
  -H "Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
```

**è¯·æ±‚å¤´æ ¼å¼**ï¼š
```
Authorization: Bearer <your-token-here>
```

### 4. Token æœ‰æ•ˆæœŸ

- **é»˜è®¤æœ‰æ•ˆæœŸ**: 7 å¤©
- **è¿‡æœŸå¤„ç†**: æ”¶åˆ° 401 çŠ¶æ€ç æ—¶ï¼Œéœ€é‡æ–°ç™»å½•è·å–æ–° Token

### 5. å¼€å‘ç¯å¢ƒ Mock Token

å¼€å‘ç¯å¢ƒæ”¯æŒä½¿ç”¨ Mock Token è¿›è¡Œæµ‹è¯•ï¼š

```bash
# Mock ç®¡ç†å‘˜ Token
export TOKEN="mock-token-admin"

curl -X GET "http://localhost:3000/api/v1/users/me" \
  -H "Authorization: Bearer $TOKEN"
```

> **è­¦å‘Š**ï¼šç”Ÿäº§ç¯å¢ƒä¸æ”¯æŒ Mock Tokenã€‚

---

## åŸºç¡€æ¥å£è°ƒç”¨

### ç¤ºä¾‹ 1ï¼šè§£æå†…å®¹é“¾æ¥

**å°çº¢ä¹¦å†…å®¹è§£æ**ï¼š

```bash
curl -X POST "http://localhost:3000/api/v1/content/parse" \
  -H "Content-Type: application/json" \
  -d '{
    "link": "https://www.xiaohongshu.com/explore/12345678"
  }'
```

**å“åº”**ï¼ˆ201 Createdï¼‰ï¼š
```json
{
  "message": "è§£ææˆåŠŸ",
  "title": "å°çº¢ä¹¦ä½œå“æ ‡é¢˜",
  "author": "ä½œè€…åç§°",
  "platform": "xiaohongshu",
  "content_id": "12345678",
  "description": "ä½œå“æè¿°...",
  "media_type": "video",
  "cover_url": "https://...",
  "media_url": "https://...",
  "all_images": ["https://...", "https://..."],
  "all_videos": ["https://..."],
  "like_count": 1234,
  "collect_count": 567,
  "comment_count": 89,
  "share_count": 45,
  "view_count": 10000,
  "publish_time": "2025-12-28T10:00:00.000Z",
  "tags": ["æ ‡ç­¾1", "æ ‡ç­¾2"],
  "source_url": "https://www.xiaohongshu.com/explore/12345678",
  "source_type": 1,
  "created_at": "2025-12-28T12:00:00.000Z"
}
```

### ç¤ºä¾‹ 2ï¼šè·å–å†…å®¹åˆ—è¡¨

```bash
curl -X GET "http://localhost:3000/api/v1/content?page=1&pageSize=20&platform=xiaohongshu"
```

**å“åº”**ï¼ˆ200 OKï¼‰ï¼š
```json
{
  "message": "è·å–æˆåŠŸ",
  "data": [
    {
      "id": "uuid",
      "title": "å†…å®¹æ ‡é¢˜",
      "author": "ä½œè€…",
      "platform": "xiaohongshu",
      ...
    }
  ],
  "pagination": {
    "total": 100,
    "page": 1,
    "pageSize": 20,
    "totalPages": 5
  }
}
```

### ç¤ºä¾‹ 3ï¼šä¿å­˜å†…å®¹åˆ°æ•°æ®åº“

```bash
curl -X POST "http://localhost:3000/api/v1/content/save" \
  -H "Content-Type: application/json" \
  -d '{
    "title": "å†…å®¹æ ‡é¢˜",
    "author": "ä½œè€…åç§°",
    "platform": "xiaohongshu",
    "content_id": "12345678",
    "description": "æè¿°",
    "media_type": "video",
    "cover_url": "https://...",
    "source_url": "https://www.xiaohongshu.com/explore/12345678"
  }'
```

---

## å¸¸è§åœºæ™¯ç¤ºä¾‹

### åœºæ™¯ 1ï¼šå®Œæ•´çš„å†…å®¹è§£æå’Œä¸‹è½½æµç¨‹

```bash
# 1. ç™»å½•è·å– Token
TOKEN=$(curl -s -X POST "http://localhost:3000/api/v1/auth/login" \
  -H "Content-Type: application/json" \
  -d '{"email": "admin@example.com", "password": "admin123"}' \
  | jq -r '.token')

# 2. è§£æå†…å®¹é“¾æ¥
curl -X POST "http://localhost:3000/api/v1/content/parse" \
  -H "Content-Type: application/json" \
  -d '{"link": "https://www.xiaohongshu.com/explore/12345678"}'

# 3. ä¿å­˜åˆ°æ•°æ®åº“
curl -X POST "http://localhost:3000/api/v1/content/save" \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer $TOKEN" \
  -d '{"link": "https://www.xiaohongshu.com/explore/12345678"}'

# 4. æŸ¥è¯¢å·²ä¿å­˜çš„å†…å®¹
curl -X GET "http://localhost:3000/api/v1/content?page=1&pageSize=10" \
  -H "Authorization: Bearer $TOKEN"
```

### åœºæ™¯ 2ï¼šè·å–ä»ªè¡¨ç›˜ç»Ÿè®¡æ•°æ®

```bash
curl -X GET "http://localhost:3000/api/v1/dashboard/stats" \
  -H "Authorization: Bearer $TOKEN"
```

**å“åº”**ï¼š
```json
{
  "message": "è·å–æˆåŠŸ",
  "data": {
    "totalContents": 1000,
    "totalAuthors": 150,
    "totalViews": 500000,
    "todayNewContents": 25,
    "platformDistribution": {
      "xiaohongshu": 600,
      "douyin": 400
    }
  }
}
```

### åœºæ™¯ 3ï¼šè·å–çƒ­æœæ•°æ®

```bash
# è·å–æ‰€æœ‰å¹³å°çƒ­æœ
curl -X GET "http://localhost:3000/api/v1/hotsearch/all" \
  -H "Authorization: Bearer $TOKEN"
```

---

## æ•…éšœæ’æŸ¥

### é—®é¢˜ 1ï¼šæ— æ³•è¿æ¥åˆ°åç«¯æœåŠ¡

**ç—‡çŠ¶**ï¼š
```
curl: (7) Failed to connect to localhost port 3000
```

**è§£å†³æ–¹æ¡ˆ**ï¼š
1. æ£€æŸ¥åç«¯æœåŠ¡æ˜¯å¦æ­£åœ¨è¿è¡Œï¼š
   ```bash
   pm2 list
   # æˆ–
   ps aux | grep node
   ```

2. æ£€æŸ¥ç«¯å£æ˜¯å¦è¢«å ç”¨ï¼š
   ```bash
   lsof -i :3000
   ```

3. æŸ¥çœ‹åç«¯æ—¥å¿—ï¼š
   ```bash
   tail -f backend/logs/combined.log
   ```

### é—®é¢˜ 2ï¼šæ•°æ®åº“è¿æ¥å¤±è´¥

**ç—‡çŠ¶**ï¼š
```json
{
  "message": "æ•°æ®åº“è¿æ¥å¤±è´¥"
}
```

**è§£å†³æ–¹æ¡ˆ**ï¼š
1. æ£€æŸ¥ PostgreSQL æ˜¯å¦è¿è¡Œï¼š
   ```bash
   # macOS
   brew services list

   # Linux
   systemctl status postgresql
   ```

2. æ£€æŸ¥æ•°æ®åº“é…ç½®ï¼š
   ```bash
   psql -U postgres -h localhost -p 5432 -d videoall
   ```

3. éªŒè¯ `.env` æ–‡ä»¶ä¸­çš„æ•°æ®åº“é…ç½®

### é—®é¢˜ 3ï¼šè®¤è¯å¤±è´¥ï¼ˆ401ï¼‰

**ç—‡çŠ¶**ï¼š
```json
{
  "message": "Tokenæ— æ•ˆæˆ–å·²è¿‡æœŸ"
}
```

**è§£å†³æ–¹æ¡ˆ**ï¼š
1. é‡æ–°ç™»å½•è·å–æ–° Token
2. æ£€æŸ¥ Token æ ¼å¼ï¼š`Authorization: Bearer <token>`
3. ç¡®è®¤ Token æœªè¿‡æœŸï¼ˆé»˜è®¤7å¤©ï¼‰
4. å¼€å‘ç¯å¢ƒå¯ä½¿ç”¨ Mock Token æµ‹è¯•

### é—®é¢˜ 4ï¼šè§£æå†…å®¹å¤±è´¥

**ç—‡çŠ¶**ï¼š
```json
{
  "message": "è§£æå¤±è´¥: ç½‘ç»œè¿æ¥è¶…æ—¶"
}
```

**è§£å†³æ–¹æ¡ˆ**ï¼š
1. æ£€æŸ¥ç½‘ç»œè¿æ¥
2. ç¡®è®¤é“¾æ¥æ ¼å¼æ­£ç¡®
3. æ£€æŸ¥å¹³å°æ˜¯å¦æ”¯æŒï¼ˆç›®å‰ä»…å°çº¢ä¹¦ã€æŠ–éŸ³ï¼‰
4. é…ç½®å¹³å° Cookie æé«˜æˆåŠŸç‡
5. æŸ¥çœ‹è§£æé”™è¯¯æ—¥å¿—ï¼š
   ```bash
   tail -f backend/logs/parse-error.log
   ```

### é—®é¢˜ 5ï¼šé€Ÿç‡é™åˆ¶ï¼ˆ429ï¼‰

**ç—‡çŠ¶**ï¼š
```json
{
  "status": "error",
  "message": "è¯·æ±‚è¿‡äºé¢‘ç¹ï¼Œè¯·ç¨åé‡è¯•",
  "code": 429
}
```

**è§£å†³æ–¹æ¡ˆ**ï¼š
1. ç­‰å¾… 15 åˆ†é’Ÿåé‡è¯•
2. å®ç°è¯·æ±‚é˜Ÿåˆ—å’ŒèŠ‚æµ
3. è°ƒæ•´é€Ÿç‡é™åˆ¶é…ç½®ï¼ˆ.env æ–‡ä»¶ï¼‰

---

## ä¸‹ä¸€æ­¥

ç°åœ¨æ‚¨å·²ç»æŒæ¡äº†åŸºç¡€ API çš„ä½¿ç”¨æ–¹æ³•ï¼Œå¯ä»¥ï¼š

1. ğŸ“– é˜…è¯»è¯¦ç»†æ¨¡å—æ–‡æ¡£ï¼š
   - [è®¤è¯æ¨¡å—è¯¦è§£](./modules/01_è®¤è¯æ¨¡å—.md)
   - [å†…å®¹ç®¡ç†è¯¦è§£](./modules/02_å†…å®¹ç®¡ç†.md)
   - [å…¶ä»–æ¨¡å—æ–‡æ¡£](./README.md#æ–‡æ¡£å¯¼èˆª)

2. ğŸ“Š æŸ¥çœ‹æ•°æ®æ¨¡å‹ï¼š
   - [Content å®ä½“](./data_models/Content_å®ä½“.md)
   - [User å®ä½“](./data_models/User_å®ä½“.md)

3. ğŸ’¡ å‚è€ƒä»£ç ç¤ºä¾‹ï¼š
   - [Android (Kotlin)](./examples/Kotlin_Retrofit.md)
   - [React (JavaScript)](./examples/JavaScript_Axios.md)
   - [iOS (Swift)](./examples/Swift_Alamofire.md)

4. ğŸ”§ æŸ¥çœ‹ OpenAPI è§„èŒƒï¼š
   - [openapi.yaml](./swagger/openapi.yaml)

---

**æœ€åæ›´æ–°**: 2025-12-28

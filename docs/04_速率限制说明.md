# é€Ÿç‡é™åˆ¶è¯´æ˜

æœ¬æ–‡æ¡£è¯´æ˜ API çš„é€Ÿç‡é™åˆ¶ç­–ç•¥ã€é…ç½®æ–¹æ³•åŠå¤„ç†å»ºè®®ã€‚

---

## ğŸ“‹ ç›®å½•

1. [é€Ÿç‡é™åˆ¶æ¦‚è¿°](#é€Ÿç‡é™åˆ¶æ¦‚è¿°)
2. [é»˜è®¤é…ç½®](#é»˜è®¤é…ç½®)
3. [é™åˆ¶è§„åˆ™](#é™åˆ¶è§„åˆ™)
4. [å“åº”æ ¼å¼](#å“åº”æ ¼å¼)
5. [å®¢æˆ·ç«¯å¤„ç†å»ºè®®](#å®¢æˆ·ç«¯å¤„ç†å»ºè®®)
6. [é…ç½®è‡ªå®šä¹‰](#é…ç½®è‡ªå®šä¹‰)

---

## é€Ÿç‡é™åˆ¶æ¦‚è¿°

### ä»€ä¹ˆæ˜¯é€Ÿç‡é™åˆ¶ï¼Ÿ

é€Ÿç‡é™åˆ¶ï¼ˆRate Limitingï¼‰æ˜¯ä¸€ç§ä¿æŠ¤ API æœåŠ¡å…å—æ»¥ç”¨å’Œè¿‡è½½çš„æœºåˆ¶ã€‚å®ƒé™åˆ¶å®¢æˆ·ç«¯åœ¨æŒ‡å®šæ—¶é—´çª—å£å†…å¯ä»¥å‘é€çš„è¯·æ±‚æ•°é‡ã€‚

### ä¸ºä»€ä¹ˆéœ€è¦é€Ÿç‡é™åˆ¶ï¼Ÿ

- âœ… **é˜²æ­¢æ»¥ç”¨**ï¼šé˜»æ­¢æ¶æ„ç”¨æˆ·æˆ–æœºå™¨äººè¿‡åº¦è¯·æ±‚
- âœ… **ä¿æŠ¤æœåŠ¡å™¨**ï¼šé¿å…æœåŠ¡å™¨è¿‡è½½ï¼Œç¡®ä¿ç¨³å®šæ€§
- âœ… **å…¬å¹³ä½¿ç”¨**ï¼šç¡®ä¿æ‰€æœ‰ç”¨æˆ·å…¬å¹³ä½¿ç”¨ API èµ„æº
- âœ… **æˆæœ¬æ§åˆ¶**ï¼šæ§åˆ¶ç¬¬ä¸‰æ–¹ API è°ƒç”¨æˆæœ¬

### é™åˆ¶æœºåˆ¶

ç³»ç»Ÿä½¿ç”¨ `express-rate-limit` ä¸­é—´ä»¶å®ç°é€Ÿç‡é™åˆ¶ï¼š

- **åŸºäº IP åœ°å€**ï¼šæ¯ä¸ª IP åœ°å€ç‹¬ç«‹è®¡æ•°
- **æ—¶é—´çª—å£**ï¼š15 åˆ†é’Ÿï¼ˆ900,000 æ¯«ç§’ï¼‰
- **è¯·æ±‚ä¸Šé™**ï¼š100 æ¬¡è¯·æ±‚
- **è·³è¿‡æˆåŠŸè¯·æ±‚**ï¼šä»…å¯¹å¤±è´¥è¯·æ±‚è®¡æ•°ï¼ˆå¯é…ç½®ï¼‰

---

## é»˜è®¤é…ç½®

### ç¯å¢ƒå˜é‡é…ç½®

åœ¨ `.env` æ–‡ä»¶ä¸­é…ç½®ï¼š

```env
# é€Ÿç‡é™åˆ¶é…ç½®
RATE_LIMIT_WINDOW_MS=900000        # æ—¶é—´çª—å£ï¼ˆæ¯«ç§’ï¼‰- 15åˆ†é’Ÿ
RATE_LIMIT_MAX_REQUESTS=100        # æœ€å¤§è¯·æ±‚æ•°
RATE_LIMIT_SKIP_SUCCESSFUL=true    # æ˜¯å¦è·³è¿‡æˆåŠŸè¯·æ±‚çš„è®¡æ•°
```

### ä»£ç å®ç°

**é…ç½®æ–‡ä»¶**: [backend/src/app.js](../backend/src/app.js)

```javascript
const rateLimit = require('express-rate-limit');

const limiter = rateLimit({
  windowMs: parseInt(process.env.RATE_LIMIT_WINDOW_MS) || 15 * 60 * 1000, // 15åˆ†é’Ÿ
  max: parseInt(process.env.RATE_LIMIT_MAX_REQUESTS) || 100,               // 100æ¬¡
  message: {
    status: 'error',
    message: 'è¯·æ±‚è¿‡äºé¢‘ç¹ï¼Œè¯·ç¨åé‡è¯•',
    code: 429
  },
  standardHeaders: true,     // è¿”å›é€Ÿç‡é™åˆ¶ä¿¡æ¯çš„ HTTP å¤´
  legacyHeaders: false,      // ç¦ç”¨ X-RateLimit-* å¤´
  skipSuccessfulRequests: true // ä»…å¯¹å¤±è´¥è¯·æ±‚è®¡æ•°
});

// åº”ç”¨åˆ°æ‰€æœ‰è·¯ç”±
app.use('/api/', limiter);
```

---

## é™åˆ¶è§„åˆ™

### é»˜è®¤è§„åˆ™

| é…ç½®é¡¹ | å€¼ | è¯´æ˜ |
|--------|-----|------|
| æ—¶é—´çª—å£ | 15 åˆ†é’Ÿ | æ»‘åŠ¨æ—¶é—´çª—å£ |
| è¯·æ±‚ä¸Šé™ | 100 æ¬¡ | æ¯ä¸ªç‹¬ç«‹ IP |
| è®¡æ•°æ–¹å¼ | ä»…å¤±è´¥è¯·æ±‚ | æˆåŠŸè¯·æ±‚ä¸è®¡æ•° |
| é‡ç½®æ—¶é—´ | çª—å£ç»“æŸå | è‡ªåŠ¨é‡ç½®è®¡æ•° |

### è®¡æ•°ç¤ºä¾‹

**åœºæ™¯ 1**ï¼šä»…å¤±è´¥è¯·æ±‚è®¡æ•°ï¼ˆå½“å‰é…ç½®ï¼‰

```
æ—¶é—´è½´ï¼š0min -------- 5min -------- 10min -------- 15min
è¯·æ±‚ï¼š â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ

å‡è®¾ 15 åˆ†é’Ÿå†…å‘é€ 200 æ¬¡è¯·æ±‚ï¼š
- æˆåŠŸè¯·æ±‚ï¼š180 æ¬¡ï¼ˆä¸è®¡å…¥é™åˆ¶ï¼‰
- å¤±è´¥è¯·æ±‚ï¼š20 æ¬¡ï¼ˆè®¡å…¥é™åˆ¶ï¼‰
- ç»“æœï¼šæœªè¶…è¿‡ 100 æ¬¡é™åˆ¶ï¼Œç»§ç»­å…è®¸è¯·æ±‚
```

**åœºæ™¯ 2**ï¼šæ‰€æœ‰è¯·æ±‚éƒ½è®¡æ•°

```
å‡è®¾ skipSuccessfulRequests = falseï¼š
- 15 åˆ†é’Ÿå†…å‘é€ 150 æ¬¡è¯·æ±‚
- ç¬¬ 101 æ¬¡è¯·æ±‚è¢«æ‹’ç»ï¼ˆ429 é”™è¯¯ï¼‰
- éœ€ç­‰å¾…æ—¶é—´çª—å£ç»“æŸ
```

### ä¾‹å¤–æƒ…å†µ

ä»¥ä¸‹è·¯ç”±**ä¸å—**é€Ÿç‡é™åˆ¶ï¼š

- âœ… å¥åº·æ£€æŸ¥è·¯ç”±ï¼ˆå¦‚ `/health`ï¼‰
- âœ… é™æ€æ–‡ä»¶æœåŠ¡
- âœ… é `/api/` è·¯å¾„ä¸‹çš„è¯·æ±‚

---

## å“åº”æ ¼å¼

### HTTP å“åº”å¤´

å½“å¯ç”¨ `standardHeaders: true` æ—¶ï¼Œæ¯ä¸ªå“åº”åŒ…å«ä»¥ä¸‹å¤´ä¿¡æ¯ï¼š

```
RateLimit-Limit: 100
RateLimit-Remaining: 95
RateLimit-Reset: 1735444800
```

**å­—æ®µè¯´æ˜**ï¼š
- `RateLimit-Limit`: æ—¶é—´çª—å£å†…çš„æœ€å¤§è¯·æ±‚æ•°ï¼ˆ100ï¼‰
- `RateLimit-Remaining`: å‰©ä½™å¯ç”¨è¯·æ±‚æ•°ï¼ˆ95ï¼‰
- `RateLimit-Reset`: é™åˆ¶é‡ç½®çš„æ—¶é—´æˆ³ï¼ˆUnix æ—¶é—´æˆ³ï¼‰

### é€Ÿç‡é™åˆ¶é”™è¯¯å“åº”

**çŠ¶æ€ç **: `429 Too Many Requests`

**å“åº”ä½“**ï¼š
```json
{
  "status": "error",
  "message": "è¯·æ±‚è¿‡äºé¢‘ç¹ï¼Œè¯·ç¨åé‡è¯•",
  "code": 429
}
```

**HTTP å“åº”å¤´**ï¼š
```
RateLimit-Limit: 100
RateLimit-Remaining: 0
RateLimit-Reset: 1735444800
Retry-After: 300
```

**å­—æ®µè¯´æ˜**ï¼š
- `Retry-After`: å»ºè®®é‡è¯•çš„ç§’æ•°ï¼ˆ300 ç§’ = 5 åˆ†é’Ÿï¼‰

---

## å®¢æˆ·ç«¯å¤„ç†å»ºè®®

### 1. æ£€æµ‹é€Ÿç‡é™åˆ¶

**JavaScript (Axios)**ï¼š
```javascript
api.interceptors.response.use(
  (response) => response,
  (error) => {
    // æ£€æµ‹ 429 é”™è¯¯
    if (error.response?.status === 429) {
      const resetTime = error.response.headers['rate-limit-reset'];
      const retryAfter = error.response.headers['retry-after'];

      console.warn('é€Ÿç‡é™åˆ¶ï¼š', {
        resetTime,
        retryAfter: `${retryAfter}ç§’`
      });
    }

    return Promise.reject(error);
  }
);
```

**Kotlin (Retrofit)**ï¼š
```kotlin
suspend fun <T> safeApiCall(apiCall: suspend () -> T): Result<T> {
    return try {
        Result.success(apiCall())
    } catch (e: HttpException) {
        if (e.code() == 429) {
            val retryAfter = e.response()?.headers()?.get("Retry-After")?.toIntOrNull()
            Result.failure(RateLimitException(retryAfter))
        } else {
            Result.failure(e)
        }
    }
}
```

**Swift (Alamofire)**ï¼š
```swift
AF.request(url).responseJSON { response in
    if let statusCode = response.response?.statusCode, statusCode == 429 {
        let retryAfter = response.response?.value(forHTTPHeaderField: "Retry-After")
        print("é€Ÿç‡é™åˆ¶ï¼Œ\(retryAfter ?? "æœªçŸ¥")ç§’åé‡è¯•")
    }
}
```

### 2. æŒ‡æ•°é€€é¿é‡è¯•

å®ç°æŒ‡æ•°é€€é¿ç®—æ³•é¿å…åŠ é‡æœåŠ¡å™¨è´Ÿæ‹…ï¼š

```javascript
const sleep = (ms) => new Promise(resolve => setTimeout(resolve, ms));

const fetchWithRetry = async (fn, maxRetries = 3) => {
  for (let i = 0; i < maxRetries; i++) {
    try {
      return await fn();
    } catch (error) {
      if (error.response?.status === 429 && i < maxRetries - 1) {
        const retryAfter = error.response.headers['retry-after'] || Math.pow(2, i);
        console.log(`é€Ÿç‡é™åˆ¶ï¼Œ${retryAfter}ç§’åé‡è¯•...`);
        await sleep(retryAfter * 1000);
      } else {
        throw error;
      }
    }
  }
};
```

### 3. è¯·æ±‚é˜Ÿåˆ—

å¯¹äºæ‰¹é‡æ“ä½œï¼Œå®ç°è¯·æ±‚é˜Ÿåˆ—æ§åˆ¶é€Ÿç‡ï¼š

```javascript
class RequestQueue {
  constructor(requestsPerSecond = 1) {
    this.queue = [];
    this.delay = 1000 / requestsPerSecond;
    this.running = false;
  }

  add(requestFn) {
    return new Promise((resolve, reject) => {
      this.queue.push({ requestFn, resolve, reject });
      if (!this.running) this.process();
    });
  }

  async process() {
    this.running = true;
    while (this.queue.length > 0) {
      const { requestFn, resolve, reject } = this.queue.shift();
      try {
        const result = await requestFn();
        resolve(result);
      } catch (error) {
        reject(error);
      }
      await new Promise(r => setTimeout(r, this.delay));
    }
    this.running = false;
  }
}

// ä½¿ç”¨ç¤ºä¾‹
const queue = new RequestQueue(0.5); // æ¯ç§’ 0.5 ä¸ªè¯·æ±‚ï¼ˆæ¯ 2 ç§’ 1 ä¸ªï¼‰

for (const link of links) {
  queue.add(() => api.parseContent(link));
}
```

### 4. æœ¬åœ°ç¼“å­˜

å‡å°‘ä¸å¿…è¦çš„ API è¯·æ±‚ï¼š

```javascript
const cache = new Map();

const getCachedData = async (key, fetchFn, ttl = 60000) => {
  const cached = cache.get(key);

  if (cached && Date.now() - cached.timestamp < ttl) {
    return cached.data;
  }

  const data = await fetchFn();
  cache.set(key, { data, timestamp: Date.now() });
  return data;
};
```

---

## é…ç½®è‡ªå®šä¹‰

### è°ƒæ•´é™åˆ¶å‚æ•°

æ ¹æ®å®é™…éœ€æ±‚è°ƒæ•´ `.env` é…ç½®ï¼š

```env
# ä¸¥æ ¼é™åˆ¶ï¼ˆé«˜æµé‡ä¿æŠ¤ï¼‰
RATE_LIMIT_WINDOW_MS=60000        # 1åˆ†é’Ÿ
RATE_LIMIT_MAX_REQUESTS=10        # 10æ¬¡

# å®½æ¾é™åˆ¶ï¼ˆå†…éƒ¨ä½¿ç”¨ï¼‰
RATE_LIMIT_WINDOW_MS=3600000      # 1å°æ—¶
RATE_LIMIT_MAX_REQUESTS=10000     # 10,000æ¬¡

# ç¦ç”¨é™åˆ¶ï¼ˆå¼€å‘ç¯å¢ƒï¼‰
RATE_LIMIT_WINDOW_MS=0
RATE_LIMIT_MAX_REQUESTS=0
```

### è·¯ç”±çº§åˆ«é™åˆ¶

ä¸ºä¸åŒè·¯ç”±è®¾ç½®ä¸åŒçš„é™åˆ¶ï¼š

```javascript
// å…¬å¼€ API - ä¸¥æ ¼é™åˆ¶
const publicLimiter = rateLimit({
  windowMs: 15 * 60 * 1000,
  max: 50
});
app.use('/api/v1/content/parse', publicLimiter);

// è®¤è¯ API - å®½æ¾é™åˆ¶
const authLimiter = rateLimit({
  windowMs: 15 * 60 * 1000,
  max: 200
});
app.use('/api/v1/dashboard', authLimiter);

// ç®¡ç†å‘˜ API - ä¸é™åˆ¶ï¼ˆåŸºäºè§’è‰²ï¼‰
// app.use('/api/v1/admin', requireAdmin);
```

### ç”¨æˆ·çº§åˆ«é™åˆ¶

åŸºäºç”¨æˆ· ID è€Œé IP åœ°å€çš„é™åˆ¶ï¼ˆéœ€è‡ªå®šä¹‰å®ç°ï¼‰ï¼š

```javascript
const userRateLimit = {};

const checkUserLimit = (userId) => {
  const now = Date.now();
  const userLimit = userRateLimit[userId] || { count: 0, resetAt: now + 900000 };

  if (now > userLimit.resetAt) {
    userLimit.count = 0;
    userLimit.resetAt = now + 900000;
  }

  if (userLimit.count >= 100) {
    return false;
  }

  userLimit.count++;
  userRateLimit[userId] = userLimit;
  return true;
};
```

---

## å¸¸è§é—®é¢˜

### Q1: ä¸ºä»€ä¹ˆæˆ‘ä¼šæ”¶åˆ° 429 é”™è¯¯ï¼Ÿ

**A**: æ‚¨åœ¨ 15 åˆ†é’Ÿå†…å‘é€äº†è¿‡å¤šå¤±è´¥è¯·æ±‚ã€‚å¯èƒ½åŸå› ï¼š
- åº”ç”¨ç¨‹åºæ— é™é‡è¯•å¤±è´¥è¯·æ±‚
- å¤šä¸ªå®¢æˆ·ç«¯å…±äº«åŒä¸€ IPï¼ˆå¦‚å…¬å¸ç½‘ç»œï¼‰
- æ¶æ„çˆ¬è™«æˆ–æ”»å‡»

**è§£å†³æ–¹æ¡ˆ**ï¼š
1. æ£€æŸ¥åº”ç”¨ç¨‹åºæ—¥å¿—ï¼Œç¡®è®¤è¯·æ±‚æ¥æº
2. å®ç°æŒ‡æ•°é€€é¿é‡è¯•æœºåˆ¶
3. ä½¿ç”¨è¯·æ±‚é˜Ÿåˆ—æ§åˆ¶é€Ÿç‡
4. è”ç³»ç®¡ç†å‘˜è°ƒæ•´é™åˆ¶

### Q2: å¦‚ä½•æé«˜é€Ÿç‡é™åˆ¶ï¼Ÿ

**A**:
1. **å¼€å‘ç¯å¢ƒ**ï¼šä¿®æ”¹ `.env` æ–‡ä»¶ç¦ç”¨æˆ–æ”¾å®½é™åˆ¶
2. **ç”Ÿäº§ç¯å¢ƒ**ï¼šè”ç³»ç®¡ç†å‘˜è¯„ä¼°åè°ƒæ•´
3. **ä¼ä¸šçº§ä½¿ç”¨**ï¼šè€ƒè™‘æä¾›ä¸“ç”¨ API å¯†é’¥ï¼Œé…ç½®ç‹¬ç«‹é™åˆ¶

### Q3: æˆåŠŸè¯·æ±‚æ˜¯å¦è®¡å…¥é™åˆ¶ï¼Ÿ

**A**: å½“å‰é…ç½®**ä¸è®¡å…¥**ï¼ˆ`skipSuccessfulRequests: true`ï¼‰ã€‚ä»…ä»¥ä¸‹è¯·æ±‚è®¡å…¥ï¼š
- 4xx é”™è¯¯ï¼ˆå®¢æˆ·ç«¯é”™è¯¯ï¼‰
- 5xx é”™è¯¯ï¼ˆæœåŠ¡å™¨é”™è¯¯ï¼‰
- è¶…æ—¶è¯·æ±‚

å¦‚éœ€æ‰€æœ‰è¯·æ±‚éƒ½è®¡å…¥ï¼Œä¿®æ”¹ `.env`ï¼š
```env
RATE_LIMIT_SKIP_SUCCESSFUL=false
```

### Q4: å¦‚ä½•æŸ¥çœ‹å‰©ä½™è¯·æ±‚æ•°ï¼Ÿ

**A**: æ£€æŸ¥å“åº”å¤´ä¸­çš„ `RateLimit-Remaining` å­—æ®µï¼š

```javascript
const remaining = response.headers['rate-limit-remaining'];
console.log(`å‰©ä½™è¯·æ±‚æ•°: ${remaining}`);
```

### Q5: é€Ÿç‡é™åˆ¶æ˜¯å…¨å±€çš„è¿˜æ˜¯æŒ‰è·¯ç”±çš„ï¼Ÿ

**A**:
- **é»˜è®¤**ï¼šå…¨å±€å…±äº«ï¼ˆæ‰€æœ‰ `/api/` è·¯ç”±ï¼‰
- **è‡ªå®šä¹‰**ï¼šå¯ä¸ºä¸åŒè·¯ç”±è®¾ç½®ç‹¬ç«‹é™åˆ¶
- **ä¾‹å¤–**ï¼šå¥åº·æ£€æŸ¥ã€é™æ€æ–‡ä»¶ä¸å—é™åˆ¶

### Q6: å¦‚ä½•åœ¨å¼€å‘ç¯å¢ƒç¦ç”¨é™åˆ¶ï¼Ÿ

**A**: ä¿®æ”¹ `.env` æ–‡ä»¶ï¼š
```env
NODE_ENV=development
RATE_LIMIT_WINDOW_MS=0
RATE_LIMIT_MAX_REQUESTS=0
```

æˆ–åœ¨ä»£ç ä¸­ï¼š
```javascript
if (process.env.NODE_ENV !== 'production') {
  // å¼€å‘ç¯å¢ƒä¸åº”ç”¨é€Ÿç‡é™åˆ¶
} else {
  app.use('/api/', limiter);
}
```

---

## ç›¸å…³æ–‡æ¡£

- [é”™è¯¯å¤„ç†ä¸çŠ¶æ€ç ](./03_é”™è¯¯å¤„ç†ä¸çŠ¶æ€ç .md)
- [è®¤è¯æœºåˆ¶è¯¦è§£](./02_è®¤è¯æœºåˆ¶è¯¦è§£.md)
- [å¿«é€Ÿå¼€å§‹æŒ‡å—](./01_å¿«é€Ÿå¼€å§‹.md)

---

## é™„å½•

### é€Ÿç‡é™åˆ¶è®¡ç®—å™¨

```javascript
// è®¡ç®—å»ºè®®çš„è¯·æ±‚é—´éš”
function calculateInterval(requests, windowMinutes) {
  const windowMs = windowMinutes * 60 * 1000;
  const intervalMs = windowMs / requests;
  return {
    intervalMs,
    intervalSeconds: (intervalMs / 1000).toFixed(2),
    requestsPerSecond: (1000 / intervalMs).toFixed(2)
  };
}

// ç¤ºä¾‹ï¼šåœ¨ 15 åˆ†é’Ÿå†…å‘é€ 100 ä¸ªè¯·æ±‚
const result = calculateInterval(100, 15);
console.log(result);
// è¾“å‡ºï¼š
// {
//   intervalMs: 9000,
//   intervalSeconds: "9.00",
//   requestsPerSecond: "0.11"
// }
```

**å»ºè®®**ï¼šæ¯ 9 ç§’å‘é€ 1 ä¸ªè¯·æ±‚ï¼Œæˆ–æ¯ç§’æœ€å¤š 0.11 ä¸ªè¯·æ±‚ã€‚

---

**æœ€åæ›´æ–°**: 2025-12-28
